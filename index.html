<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Amazon Performance Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <!-- Plugin for drawing annotations (quadrant lines) -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@1.4.0/dist/chartjs-plugin-annotation.min.js"></script>
    <!-- Plugin for displaying data labels on the chart -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        @import url('https://rsms.me/inter/inter.css');
        html { font-family: 'Inter', sans-serif; }
        body { font-family: 'Inter', sans-serif; scroll-behavior: smooth; background-color: #f1f5f9; }
        
        .chart-container { position: relative; height: 45vh; width: 100%; }
        .large-chart-container { position: relative; height: 60vh; width: 100%; }
        .small-chart-container { position: relative; height: 40vh; width: 100%; }
        
        .card { background-color: white; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.05), 0 2px 4px -2px rgb(0 0 0 / 0.05); transition: all 0.2s ease-in-out; border: 1px solid #e2e8f0; }
        .card:hover { transform: translateY(-3px); box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); }
        
        .loader { border: 6px solid #e5e7eb; border-radius: 50%; border-top: 6px solid #4f46e5; width: 50px; height: 50px; animation: spin 1.5s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        ::-webkit-scrollbar { width: 8px; } ::-webkit-scrollbar-track { background: #e2e8f0; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 10px; } ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        
        /* Navigation Tabs */
        .tab-button { padding: 0.75rem 1.5rem; font-weight: 600; color: #475569; border-bottom: 3px solid transparent; cursor: pointer; transition: all 0.2s ease-in-out; }
        .tab-button:hover { color: #1e293b; background-color: #f8fafc; }
        .tab-button.active { color: #4f46e5; border-bottom-color: #4f46e5; background-color: white; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Toggle Switch */
        .toggle-checkbox:checked { right: 0; border-color: #4f46e5; }
        .toggle-checkbox:checked + .toggle-label { background-color: #4f46e5; }

        /* Product/Contact Search Filter */
        .sortable-header { cursor: pointer; user-select: none; }
        .sortable-header:hover { color: #3b82f6; }
        .search-dropdown { max-height: 200px; overflow-y: auto; z-index: 50; }
        .search-pill { display: inline-flex; align-items: center; background-color: #e0e7ff; color: #3730a3; border-radius: 9999px; padding: 4px 10px; font-size: 0.875rem; font-weight: 500; margin: 2px; }
        .search-pill button { margin-left: 6px; background: none; border: none; color: #4f46e5; cursor: pointer; font-weight: bold; }
        
        /* KPI Card new style */
        .kpi-card { background-color: white; border-radius: 0.75rem; padding: 1.25rem; display: flex; flex-direction: column; justify-content: space-between; }
        
        /* AI Modal & Content Styling */
        #aiModal { background-color: rgba(0,0,0,0.5); }
        .ai-modal-content { max-height: 80vh; overflow-y: auto; }
        .prose h1, .prose h2, .prose h3 { margin-top: 1.25em; margin-bottom: 0.5em; font-weight: 600; color: #111827 }
        .prose h1 { font-size: 1.875rem; border-bottom: 1px solid #d1d5db; padding-bottom: 0.3em; }
        .prose h2 { font-size: 1.5rem; border-bottom: 1px solid #e5e7eb; padding-bottom: 0.3em; }
        .prose h3 { font-size: 1.25rem; }
        .prose p { margin-top: 1em; margin-bottom: 1em; line-height: 1.6; }
        .prose ul { list-style-type: disc; margin-left: 1.5rem; margin-top: 1em; margin-bottom: 1em; }
        .prose li { margin-top: 0.25em; margin-bottom: 0.25em; }
        .prose table { width: 100%; border-collapse: collapse; margin-top: 1em; margin-bottom: 1em; box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1); }
        .prose th, .prose td { border: 1px solid #e5e7eb; padding: 0.5rem 0.75rem; text-align: left; }
        .prose th { background-color: #f9fafb; font-weight: 600; }

        /* Matrix, Keepa & SQP Table Styling */
        .matrix-style-table-container table { border-collapse: separate; border-spacing: 0; }
        .matrix-style-table-container th, .matrix-style-table-container td { border-bottom: 1px solid #e2e8f0; border-right: 1px solid #e2e8f0; }
        .matrix-style-table-container th:first-child, .matrix-style-table-container td:first-child { position: sticky; left: 0; z-index: 10; background-color: white; }
        #keepaTableContainer th:nth-child(2), #keepaTableContainer td:nth-child(2) { position: sticky; left: 90px; z-index: 10; background-color: white; }
        .matrix-style-table-container th:last-child, .matrix-style-table-container td:last-child { border-right: 0; }
        .matrix-style-table-container thead th { background-color: #f8fafc; position: sticky; top: 0; z-index: 20; }
        #keepaTableContainer thead th:nth-child(2) { z-index: 21; }
        #sqpTableContainer thead th { top: 0; z-index: 15; }
        .matrix-style-table-container .asin-header-row td { background-color: #f1f5f9; font-weight: 600; position: sticky; top: 89px; /* Adjust based on header height */ z-index: 15; }
        .matrix-style-table-container .metric-name-col { font-weight: 500; }
        .matrix-style-table-container .sort-metric-selector { cursor: pointer; user-select: none; }
        .matrix-style-table-container .sort-metric-selector.primary-sort-metric { background-color: #e0e7ff; font-weight: 600; color: #3730a3;}
        .matrix-style-table-container .value-col { text-align: right; }
        .matrix-style-table-container .change-col { text-align: right; }
        .matrix-style-table-container .change-col span { display: inline-block; padding: 0.25rem 0.5rem; border-radius: 0.375rem; font-size: 0.8rem; min-width: 60px; text-align: center;}
        .sortable-header:hover { background-color: #f1f5f9; }
        .sort-arrow { display: inline-block; margin-left: 5px; opacity: 0.5; }
        .matrix-style-table-container tfoot { border-top: 2px solid #94a3b8; }
        .matrix-style-table-container tfoot td { background-color: #f8fafc; font-weight: 600; }
        .matrix-style-table-container .group-header td { background-color: #e2e8f0; font-weight: 700; color: #475569; padding: 0.5rem 1rem; }
        .matrix-style-table-container .product-title-cell { max-width: 300px; white-space: normal; }
        #sqpTableContainer .our-product { background-color: #eef2ff; font-weight: 500; }
        #topMoversTable table, #topDeclinersTable table, #wholesaleBestSellersContainer table, #wholesaleTopMoversContainer table, #wholesaleTopDeclinersContainer table { width: 100%; text-align: left; font-size: 0.875rem;}
        #topMoversTable th, #topDeclinersTable th, #wholesaleBestSellersContainer th, #wholesaleTopMoversContainer th, #wholesaleTopDeclinersContainer th { padding: 0.5rem 1rem; }
        #topMoversTable td, #topDeclinersTable td, #wholesaleBestSellersContainer td, #wholesaleTopMoversContainer td, #wholesaleTopDeclinersContainer td { padding: 0.5rem 1rem; }
        
        /* Keepa Metric Selector */
        #keepaMetricSelector .metric-item { display: flex; align-items: center; padding: 4px; border-radius: 4px; }
        #keepaMetricSelector .metric-item:hover { background-color: #f1f5f9; }
        #keepaMetricSelector .metric-item label { width: 100%; cursor: pointer; }

        /* Platform Selector Styles */
        .platform-btn {
            padding: 1rem;
            font-size: 1.125rem;
            font-weight: 600;
            color: white;
            background-color: #4f46e5;
            border-radius: 0.5rem;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .platform-btn:hover {
            background-color: #4338ca;
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }

    </style>
</head>
<body class="bg-slate-100 text-slate-800">

    <!-- Platform Selector Modal -->
    <div id="platformSelector" class="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/60 backdrop-blur-sm">
        <div class="bg-white rounded-lg shadow-2xl p-8 w-full max-w-md mx-4 text-center">
            <h2 class="text-3xl font-bold text-slate-800 mb-6">Select a Dashboard</h2>
            <div class="grid grid-cols-1 gap-4">
                <button data-platform="WHOLESALE" class="platform-btn bg-emerald-600 hover:bg-emerald-700">Wholesale Sales</button>
                <hr class="my-2 border-slate-200">
                <button data-platform="EU_CONSOLIDATED" class="platform-btn bg-yellow-500 hover:bg-yellow-600">Consolidated EU</button>
                <hr class="my-2 border-slate-200">
                <button data-platform="UK" class="platform-btn">United Kingdom (UK)</button>
                <button data-platform="DE" class="platform-btn">Germany (DE)</button>
                <button data-platform="FR" class="platform-btn">France (FR)</button>
                <button data-platform="ES" class="platform-btn">Spain (ES)</button>
                <button data-platform="CA" class="platform-btn">Canada (CA)</button>
            </div>
        </div>
    </div>


    <!-- Hidden textareas for the script to use -->
    <div style="display:none;">
        <textarea id="csvData"></textarea>
        <textarea id="combinedRankData"></textarea>
        <textarea id="wholesaleData"></textarea>
        <div id="mappingUI"></div> <!-- Keep a hidden mapping UI for the script -->
    </div>

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <header class="mb-10 text-center">
            <h1 id="main-title" class="text-5xl font-extrabold text-slate-900 tracking-tight">Performance Dashboard</h1>
            <p id="main-subtitle" class="text-xl text-slate-500 mt-2">Your AI-powered command center for sales and advertising analysis.</p>
        </header>

        <div id="loading" class="hidden my-8 flex items-center justify-center"><div class="loader mr-4"></div><p class="text-lg text-slate-700">Fetching and analyzing cloud data...</p></div>
        <div id="errorLog" class="hidden my-8 p-4 bg-red-100 text-red-800 border-l-4 border-red-500 rounded-lg shadow-md"></div>
        
        <div id="dashboardContainer" class="hidden">
            <!-- Navigation Tabs -->
            <div class="bg-white rounded-lg shadow-sm mb-8 sticky top-0 z-40">
                <nav class="flex flex-wrap -mb-px" id="tabContainer">
                    <button class="tab-button" data-tab="deepdive">Product Deep-Dive</button>
                    <button class="tab-button" data-tab="wholesale">Wholesale Sales</button>
                    <button class="tab-button" data-tab="matrix">Matrix</button>
                    <button class="tab-button" data-tab="analysis">✨ AI Strategic Analysis</button>
                </nav>
            </div>

            <!-- Dashboard Content Area -->
            <div id="dashboardContentArea">
                <!-- Deep Dive Tab -->
                <div id="deepdiveTab" class="tab-content space-y-8">
                     <div class="card p-6">
                         <div class="flex flex-col md:flex-row items-center justify-center space-y-4 md:space-y-0 md:space-x-6">
                            <div class="flex-grow w-full md:w-auto relative">
                                <label for="productSearchInput" class="block text-center md:text-left text-lg font-medium text-slate-700 mb-2">Filter by Product(s):</label>
                                <div id="productSearchContainer" class="p-2 border border-slate-300 bg-white rounded-md shadow-sm">
                                    <div id="productSearchPills" class="flex flex-wrap gap-1 mb-1"></div>
                                    <input type="text" id="productSearchInput" placeholder="Search products (or leave blank for all)..." class="w-full border-0 focus:ring-0 p-1">
                                </div>
                                <div id="productSearchDropdown" class="absolute z-10 w-full mt-1 bg-white border border-slate-300 rounded-md shadow-lg hidden search-dropdown"></div>
                            </div>
                            <div class="flex-shrink-0">
                                <label for="timePeriodSelector" class="block text-center md:text-left text-lg font-medium text-slate-700 mb-2">Time Period:</label>
                                <select id="timePeriodSelector" class="p-2 border border-slate-300 bg-white rounded-md shadow-sm text-lg">
                                    <option value="7">Last 7 Days</option><option value="14">Last 2 Weeks</option><option value="28" selected>Last 4 Weeks</option>
                                    <option value="182">Last 6 Months</option><option value="365">Last 1 Year</option>
                                    <option value="qtd">Quarter to Date</option><option value="ytd">Year to Date</option>
                                </select>
                                 <p id="kpiTimeRangeText" class="text-xs text-slate-500 text-center mt-1"></p>
                            </div>
                        </div>
                    </div>

                    <!-- UPDATED KPI GRID -->
                    <div id="kpi-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                        <div id="kpi-revenue" class="kpi-card"></div>
                        <div id="kpi-units" class="kpi-card"></div>
                        <div id="kpi-adSpend" class="kpi-card"></div>
                        <div id="kpi-adSales" class="kpi-card"></div>
                        <div id="kpi-acos" class="kpi-card"></div>
                        <div id="kpi-tacos" class="kpi-card"></div>
                        <div id="kpi-roas" class="kpi-card"></div>
                        <div id="kpi-impressions" class="kpi-card"></div>
                        <div id="kpi-clicks" class="kpi-card"></div>
                        <div id="kpi-ctr" class="kpi-card"></div>
                        <div id="kpi-cpc" class="kpi-card"></div>
                        <div id="kpi-adConversionRate" class="kpi-card"></div> <!-- NEW -->
                        <div id="kpi-glanceViews" class="kpi-card"></div>
                        <div id="kpi-conversionRate" class="kpi-card"></div>
                        <div id="kpi-adSalesRatio" class="kpi-card"></div>
                        <div id="kpi-oos" class="kpi-card"></div>
                    </div>
                    
                    <div class="card p-6">
                         <h2 class="text-xl font-bold text-slate-800 mb-4">Sales Mix Analysis</h2>
                         <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 items-center">
                            <div class="lg:col-span-1">
                                <div>
                                    <label for="pieChartTimeSelector" class="block text-sm font-medium text-slate-700">Time Period:</label>
                                    <select id="pieChartTimeSelector" class="w-full mt-1 p-2 border border-slate-300 bg-white rounded-md shadow-sm">
                                        <option value="7">Last 7 Days</option><option value="14">Last 2 Weeks</option><option value="28" selected>Last 4 Weeks</option>
                                        <option value="182">Last 6 Months</option><option value="365">Last 1 Year</option>
                                    </select>
                                    <p id="pieTimeRangeText" class="text-xs text-slate-500 mt-1"></p>
                                </div>
                                <div class="mt-4">
                                    <label for="pieChartMetricSelector" class="block text-sm font-medium text-slate-700">Metric:</label>
                                    <select id="pieChartMetricSelector" class="w-full mt-1 p-2 border border-slate-300 bg-white rounded-md shadow-sm">
                                        <option value="revenue" selected>Revenue</option>
                                        <option value="units">Units Sold</option>
                                        <option value="adSpend">Ad Spend</option>
                                        <option value="adSales">Ad Sales</option>
                                        <option value="roas">ROAS</option>
                                        <option value="acos">ACoS</option>
                                        <option value="tacos">TACOS</option>
                                        <option value="glanceViews">Glance Views</option>
                                        <option value="impressions">Impressions</option>
                                        <option value="clicks">Clicks</option>
                                    </select>
                                </div>
                                <div class="mt-4">
                                     <label for="pieChartProductSelector" class="block text-sm font-medium text-slate-700">Products to show (defaults to Top 10):</label>
                                     <select id="pieChartProductSelector" multiple class="w-full mt-1 p-2 border border-slate-300 bg-white rounded-md shadow-sm" style="height: 12rem;"></select>
                                </div>
                            </div>
                            <div class="lg:col-span-2 chart-container">
                                <canvas id="salesMixChart"></canvas>
                            </div>
                            <div id="salesPenetrationChartContainer" class="lg:col-span-3 mt-6 hidden">
                                <h3 id="salesPenetrationChartTitle" class="text-lg font-semibold text-slate-800 mb-2 text-center"></h3>
                                <div class="small-chart-container" style="height: 250px;">
                                    <canvas id="salesPenetrationChart"></canvas>
                                </div>
                            </div>
                         </div>
                    </div>

                    <div class="card p-6">
                        <h2 class="text-2xl font-bold mb-4 text-slate-800 border-b border-slate-200 pb-3">Single Product Deep-Dive</h2>
                        <div class="mb-6"><label for="skuSelector" class="block text-sm font-medium text-slate-700 mb-1">Select an ASIN or Overall View:</label><select id="skuSelector" class="w-full md:w-1/2 p-2 border border-slate-300 bg-white rounded-md shadow-sm"></select></div>
                        <div id="skuDashboard" class="hidden">
                             <div class="bg-slate-50 p-6 rounded-xl border border-slate-200 space-y-8">
                                
                                <div class="bg-white p-4 rounded-lg border border-slate-200">
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                                        <div><label for="skuStartDate" class="block text-sm font-medium text-slate-600">Start Date</label><input type="date" id="skuStartDate" class="mt-1 w-full p-2 border border-slate-300 rounded-md"></div>
                                        <div><label for="skuEndDate" class="block text-sm font-medium text-slate-600">End Date</label><input type="date" id="skuEndDate" class="mt-1 w-full p-2 border border-slate-300 rounded-md"></div>
                                        <div class="flex space-x-2">
                                            <button id="skuFilterBtn" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-indigo-700 w-full transition-colors">Filter</button>
                                            <button id="analyzeSkuBtn" class="bg-purple-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-purple-700 transition duration-300 w-full flex items-center justify-center">✨ Analyze</button>
                                        </div>
                                    </div>
                                </div>

                                <div>
                                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4">
                                        <h3 class="text-xl font-semibold mb-2 md:mb-0 text-slate-800">Weekly Revenue & Driver Analysis</h3>
                                        <div class="flex items-center">
                                            <label for="skuDriverSelector" class="mr-2 text-sm font-medium text-slate-700">Overlay Metrics:</label>
                                            <select id="skuDriverSelector" multiple class="p-2 border border-slate-300 bg-white rounded-md shadow-sm" style="height: 100px;"></select>
                                        </div>
                                    </div>
                                    <div class="chart-container"><canvas id="skuRevenueChart"></canvas></div>
                                </div>
                                
                                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 pt-8 border-t border-slate-200">
                                   <div>
                                        <h3 class="text-lg font-semibold mb-4 text-slate-800">Ad Efficiency Trend</h3>
                                        <div class="small-chart-container"><canvas id="skuAdEfficiencyChart"></canvas></div>
                                   </div>
                                   <div>
                                        <h3 class="text-lg font-semibold mb-4 text-slate-800">Sales Composition</h3>
                                        <div class="small-chart-container"><canvas id="skuSalesCompositionChart"></canvas></div>
                                   </div>
                                   <div>
                                        <h3 class="text-lg font-semibold mb-4 text-slate-800">Pricing & Demand</h3>
                                        <div class="small-chart-container"><canvas id="skuPriceElasticityChart"></canvas></div>
                                   </div>
                                   <div>
                                        <h3 class="text-lg font-semibold mb-4 text-slate-800">Top of Funnel</h3>
                                        <div class="small-chart-container"><canvas id="skuFunnelChart"></canvas></div>
                                   </div>
                                    <div>
                                        <h3 class="text-lg font-semibold mb-4 text-slate-800">Operational Health</h3>
                                        <div class="small-chart-container"><canvas id="skuOosChart"></canvas></div>
                                   </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Movers & Decliners Section -->
                    <div class="card p-6">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 flex-wrap">
                            <h2 class="text-2xl font-bold text-slate-800 mb-2 sm:mb-0">Movers & Decliners</h2>
                            <div class="flex items-center space-x-4 flex-wrap">
                                <div class="mt-2 sm:mt-0">
                                    <label for="moversMetricSelector" class="mr-2 text-sm font-medium text-slate-700">Metric:</label>
                                    <select id="moversMetricSelector" class="p-2 border border-slate-300 bg-white rounded-md shadow-sm"></select>
                                </div>
                                <div class="mt-2 sm:mt-0">
                                    <label for="moversTimeSelector" class="mr-2 text-sm font-medium text-slate-700">Compare Period:</label>
                                    <select id="moversTimeSelector" class="p-2 border border-slate-300 bg-white rounded-md shadow-sm">
                                        <option value="7">Last 7 Days</option><option value="14">Last 2 Weeks</option>
                                        <option value="28" selected>Last 4 Weeks</option><option value="182">Last 6 Months</option><option value="365">Last 1 Year</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Movers & Decliners Filter -->
                        <div id="moversFilterControls" class="my-6 p-4 bg-slate-50 border border-slate-200 rounded-lg">
                            <h4 class="text-lg font-semibold text-slate-800 mb-3">Filter Movers & Decliners List</h4>
                            <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-4 items-end">
                                <div>
                                    <label for="moversFilterMetric" class="block text-sm font-medium text-slate-700 mb-1">Filter by Metric</label>
                                    <select id="moversFilterMetric" class="w-full p-2 border border-slate-300 bg-white rounded-md shadow-sm text-base"></select>
                                </div>
                                <div>
                                    <label for="moversFilterPeriod" class="block text-sm font-medium text-slate-700 mb-1">in Time Period</label>
                                    <select id="moversFilterPeriod" class="w-full p-2 border border-slate-300 bg-white rounded-md shadow-sm text-base"></select>
                                </div>
                                <div>
                                    <label for="moversFilterColumn" class="block text-sm font-medium text-slate-700 mb-1">on Column</label>
                                    <select id="moversFilterColumn" class="w-full p-2 border border-slate-300 bg-white rounded-md shadow-sm text-base">
                                        <option value="currentValue">Value</option>
                                        <option value="change">% Change</option>
                                    </select>
                                </div>
                                <div class="lg:col-span-2">
                                    <div class="grid grid-cols-3 gap-2 items-end">
                                        <div>
                                            <label for="moversFilterOperator" class="block text-sm font-medium text-slate-700 mb-1">is</label>
                                            <select id="moversFilterOperator" class="w-full p-2 border border-slate-300 bg-white rounded-md shadow-sm text-base">
                                                <option value="gt">&gt; (Greater than)</option>
                                                <option value="lt">&lt; (Less than)</option>
                                                <option value="between">Between</option>
                                            </select>
                                        </div>
                                        <div class="col-span-2 grid grid-cols-2 gap-2 items-end">
                                            <input type="number" id="moversFilterValue1" placeholder="Value" class="w-full p-2 border border-slate-300 rounded-md">
                                            <input type="number" id="moversFilterValue2" placeholder="Value" class="w-full p-2 border border-slate-300 rounded-md hidden">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="flex space-x-3 mt-4">
                                <button id="applyMoversFilterBtn" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-blue-700 transition-colors">Apply Filter</button>
                                <button id="clearMoversFilterBtn" class="bg-slate-500 text-white font-semibold py-2 px-4 rounded-md hover:bg-slate-600 transition-colors">Clear Filters</button>
                            </div>
                            <p class="text-xs text-slate-500 mt-2">Note: For '% Change', enter numbers like 10 for 10% or -20 for -20%.</p>
                        </div>
                        
                        <p id="moversTimeRangeText" class="text-xs text-slate-500 text-center mt-2 mb-4"></p>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-10 mt-4">
                            <div>
                                <h3 class="text-xl font-semibold mb-4 text-center">Top 20 Product Uplifts</h3>
                                <div id="topMoversTableContainer" class="overflow-x-auto"><div id="topMoversTable"></div></div>
                            </div>
                            <div>
                                <h3 class="text-xl font-semibold mb-4 text-center">Top 20 Product Downlifts</h3>
                                <div id="topDeclinersTableContainer" class="overflow-x-auto"><div id="topDeclinersTable"></div></div>
                            </div>
                        </div>
                    </div>

                    <!-- Flywheel Health Diagnosis Section -->
                    <div class="card p-6">
                        <h2 class="text-2xl font-bold text-slate-800 mb-4">Flywheel Health Diagnosis</h2>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                            <div>
                                <label for="flywheelAsinSelector" class="block text-sm font-medium text-slate-700 mb-1">Select an ASIN:</label>
                                <select id="flywheelAsinSelector" class="w-full p-2 border border-slate-300 bg-white rounded-md shadow-sm"></select>
                            </div>
                            <div>
                                <label for="flywheelTimeSelector" class="block text-sm font-medium text-slate-700 mb-1">Select Time Period:</label>
                                <select id="flywheelTimeSelector" class="w-full p-2 border border-slate-300 bg-white rounded-md shadow-sm">
                                    <option value="13" selected>Last 13 Weeks (Qtr)</option>
                                    <option value="26">Last 26 Weeks</option>
                                    <option value="52">Last 52 Weeks</option>
                                </select>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                            <div class="small-chart-container">
                                <canvas id="flywheelOosChart"></canvas>
                            </div>
                            <div class="small-chart-container">
                                <canvas id="flywheelGvChart"></canvas>
                            </div>
                            <div class="small-chart-container">
                                <canvas id="flywheelCrChart"></canvas>
                            </div>
                        </div>
                        <div class="mt-6 bg-slate-50 p-4 rounded-lg border border-slate-200">
                             <h3 class="text-lg font-semibold text-slate-800 mb-2">Flywheel Health Conclusion</h3>
                             <div id="flywheelNarrative" class="text-sm text-slate-600 space-y-2"></div>
                        </div>
                    </div>

                    <!-- Ranking & Competitor Analysis Section -->
                    <div class="card p-6" id="rankingAnalysisSection">
                        <h2 class="text-2xl font-bold text-slate-800 mb-4 border-b pb-3">Ranking & Competitor Analysis</h2>
                        <div id="rankingControls" class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6 items-end">
                            <div>
                                <label for="mainAsinFilterSelector" class="block text-sm font-medium text-slate-700 mb-1">1. Competitor Group</label>
                                <select id="mainAsinFilterSelector" class="w-full p-2 border border-slate-300 bg-white rounded-md shadow-sm"></select>
                            </div>
                            <div>
                                <label for="keywordFilterSelector" class="block text-sm font-medium text-slate-700 mb-1">2. Keyword</label>
                                <select id="keywordFilterSelector" class="w-full p-2 border border-slate-300 bg-white rounded-md shadow-sm" disabled></select>
                            </div>
                             <div>
                                <label for="rankTypeSelector" class="block text-sm font-medium text-slate-700 mb-1">Rank Type</label>
                                <select id="rankTypeSelector" class="w-full p-2 border border-slate-300 bg-white rounded-md shadow-sm">
                                    <option value="organicRank" selected>Organic</option>
                                    <option value="sponsoredRank">Sponsored</option>
                                </select>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label for="rankingStartDate" class="block text-sm font-medium text-slate-700 mb-1">Start Date:</label>
                                    <input type="date" id="rankingStartDate" class="w-full p-2 border border-slate-300 rounded-md">
                                </div>
                                <div>
                                    <label for="rankingEndDate" class="block text-sm font-medium text-slate-700 mb-1">End Date:</label>
                                    <input type="date" id="rankingEndDate" class="w-full p-2 border border-slate-300 rounded-md">
                                </div>
                            </div>
                        </div>
                        <div class="space-y-12">
                            <div>
                                <h3 id="competitorRankingChartTitle" class="text-xl font-semibold mb-4 text-slate-800">Competitive Rank Landscape</h3>
                                <div class="large-chart-container">
                                    <canvas id="competitorRankingChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- UPDATED Wholesale Tab -->
                <div id="wholesaleTab" class="tab-content space-y-8">
                    <div class="card p-6">
                        <h2 class="text-2xl font-bold text-slate-900 mb-4">Wholesale Performance</h2>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 items-end p-4 bg-slate-50 border rounded-lg">
                            <div>
                                <label for="wholesaleStartDate" class="block text-sm font-medium text-slate-700">Start Date:</label>
                                <input type="date" id="wholesaleStartDate" class="mt-1 p-2 border border-slate-300 rounded-md w-full">
                            </div>
                            <div>
                                <label for="wholesaleEndDate" class="block text-sm font-medium text-slate-700">End Date:</label>
                                <input type="date" id="wholesaleEndDate" class="mt-1 p-2 border border-slate-300 rounded-md w-full">
                            </div>
                             <div class="relative">
                                <label for="wholesaleContactSearchInput" class="block text-sm font-medium text-slate-700">Filter by Contact(s):</label>
                                <div id="wholesaleContactSearchContainer" class="mt-1 p-1 border border-slate-300 bg-white rounded-md shadow-sm">
                                    <div id="wholesaleContactSearchPills" class="flex flex-wrap gap-1 mb-1"></div>
                                    <input type="text" id="wholesaleContactSearchInput" placeholder="Search contacts..." class="w-full border-0 focus:ring-0 p-1">
                                </div>
                                <div id="wholesaleContactSearchDropdown" class="absolute z-10 w-full mt-1 bg-white border border-slate-300 rounded-md shadow-lg hidden search-dropdown"></div>
                                <button id="wholesaleShowAllContactsBtn" class="text-sm text-indigo-600 hover:text-indigo-800 font-semibold mt-2">Show All Contacts</button>
                            </div>
                        </div>
                    </div>

                    <div class="card p-6">
                        <h3 class="text-xl font-semibold text-slate-800 mb-4">Product Performance Summary</h3>
                        <div id="wholesale-kpi-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                            <div id="kpi-uniqueProducts" class="kpi-card"></div>
                            <div id="kpi-topProduct" class="kpi-card"></div>
                            <div id="kpi-revenueConcentration" class="kpi-card"></div>
                            <div id="kpi-avgRevenuePerProduct" class="kpi-card"></div>
                        </div>
                    </div>

                    <div class="card p-6">
                         <h3 class="text-xl font-semibold text-slate-800 mb-4">Best-Sellers & High-Reach Products</h3>
                         <div id="wholesaleBestSellersContainer" class="overflow-x-auto"></div>
                    </div>

                    <div class="card p-6">
                        <h3 class="text-xl font-semibold text-slate-800 mb-4">Product Sales Concentration</h3>
                        <div class="large-chart-container"><canvas id="wholesaleParetoChart"></canvas></div>
                    </div>

                    <div class="card p-6">
                        <h3 class="text-xl font-semibold text-slate-800 mb-4">Product Movers & Decliners</h3>
                        <p id="wholesaleMoversTimeRangeText" class="text-xs text-slate-500 mb-4"></p>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-10">
                             <div>
                                 <h4 class="text-lg font-semibold mb-2 text-center">Top 20 Product Uplifts</h4>
                                 <div id="wholesaleTopMoversContainer" class="overflow-x-auto"></div>
                             </div>
                             <div>
                                 <h4 class="text-lg font-semibold mb-2 text-center">Top 20 Product Downlifts</h4>
                                 <div id="wholesaleTopDeclinersContainer" class="overflow-x-auto"></div>
                             </div>
                        </div>
                    </div>

                    <div class="card p-6">
                         <h3 class="text-xl font-semibold text-slate-800 mb-4">Weekly Sales by Contact</h3>
                         <div class="mb-6">
                             <h4 class="text-base font-semibold text-slate-700 mb-2">Select a Week for Overall Product Breakdown:</h4>
                             <div id="wholesaleWeekSelectorContainer" class="flex flex-wrap gap-2"></div>
                         </div>
                        <p class="text-slate-600 mb-6">Analyze sales data by contact. Click on a contact within a bar to see their product breakdown, or use the buttons above for an overall product view for a specific week.</p>
                        <div class="large-chart-container">
                            <canvas id="wholesaleChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- NEW Matrix Tab -->
                <div id="matrixTab" class="tab-content space-y-8">
                    <div class="card p-6">
                        <h2 class="text-2xl font-bold text-slate-900 mb-4">Comparison Matrix</h2>
                        <p class="text-slate-600 mb-6">Build a custom comparison table to analyze multiple products, metrics, and time periods side-by-side. The '% Change' column shows the change versus the prior period of the same length.</p>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div>
                                <label for="matrixMetricSelector" class="block text-sm font-medium text-slate-700 mb-1">1. Select Metrics</label>
                                <select id="matrixMetricSelector" multiple class="w-full p-2 border border-slate-300 bg-white rounded-md shadow-sm text-base" style="height: 15rem;"></select>
                            </div>
                            <div>
                                <label for="matrixAsinSelector" class="block text-sm font-medium text-slate-700 mb-1">2. Select Products</label>
                                <select id="matrixAsinSelector" multiple class="w-full p-2 border border-slate-300 bg-white rounded-md shadow-sm text-base" style="height: 15rem;"></select>
                            </div>
                            <div>
                                <label for="matrixTimePeriodSelector" class="block text-sm font-medium text-slate-700 mb-1">3. Select Time Periods</label>
                                <select id="matrixTimePeriodSelector" multiple class="w-full p-2 border border-slate-300 bg-white rounded-md shadow-sm text-base" style="height: 15rem;">
                                    <option value="7">Last 7 Days</option>
                                    <option value="14">Last 2 Weeks</option>
                                    <option value="28" selected>Last 4 Weeks</option>
                                    <option value="91">Last Quarter (13 wks)</option>
                                    <option value="182">Last 6 Months (26 wks)</option>
                                    <option value="365">Last 1 Year (52 wks)</option>
                                </select>
                            </div>
                        </div>
                        <button id="generateMatrixBtn" class="mt-6 bg-indigo-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-indigo-700 transition duration-300 flex items-center justify-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path d="M7 3a1 1 0 000 2h6a1 1 0 100-2H7zM4 7a1 1 0 011-1h10a1 1 0 110 2H5a1 1 0 01-1-1zM2 11a1 1 0 011-1h14a1 1 0 110 2H3a1 1 0 01-1-1zM2 15a1 1 0 011-1h14a1 1 0 110 2H3a1 1 0 01-1-1z" /></svg>
                            Generate Matrix
                        </button>
                    </div>
                    <div class="card p-6">
                        <!-- NEW: Filter Controls -->
                        <div id="matrixFilterControls" class="mb-6 p-4 bg-slate-50 border border-slate-200 rounded-lg">
                            <h4 class="text-lg font-semibold text-slate-800 mb-3">Filter Matrix Results</h4>
                            <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-4 items-end">
                                <div>
                                    <label for="matrixFilterMetric" class="block text-sm font-medium text-slate-700 mb-1">Filter by Metric</label>
                                    <select id="matrixFilterMetric" class="w-full p-2 border border-slate-300 bg-white rounded-md shadow-sm text-base"></select>
                                </div>
                                <div>
                                    <label for="matrixFilterPeriod" class="block text-sm font-medium text-slate-700 mb-1">in Time Period</label>
                                    <select id="matrixFilterPeriod" class="w-full p-2 border border-slate-300 bg-white rounded-md shadow-sm text-base"></select>
                                </div>
                                <div>
                                    <label for="matrixFilterColumn" class="block text-sm font-medium text-slate-700 mb-1">on Column</label>
                                    <select id="matrixFilterColumn" class="w-full p-2 border border-slate-300 bg-white rounded-md shadow-sm text-base">
                                        <option value="currentValue">Value</option>
                                        <option value="change">% Change</option>
                                    </select>
                                </div>
                                <div class="lg:col-span-2">
                                    <div class="grid grid-cols-3 gap-2 items-end">
                                        <div>
                                            <label for="matrixFilterOperator" class="block text-sm font-medium text-slate-700 mb-1">is</label>
                                            <select id="matrixFilterOperator" class="w-full p-2 border border-slate-300 bg-white rounded-md shadow-sm text-base">
                                                <option value="gt">&gt; (Greater than)</option>
                                                <option value="lt">&lt; (Less than)</option>
                                                <option value="between">Between</option>
                                            </select>
                                        </div>
                                        <div class="col-span-2 grid grid-cols-2 gap-2 items-end">
                                            <input type="number" id="matrixFilterValue1" placeholder="Value" class="w-full p-2 border border-slate-300 rounded-md">
                                            <input type="number" id="matrixFilterValue2" placeholder="Value" class="w-full p-2 border border-slate-300 rounded-md hidden">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="flex space-x-3 mt-4">
                                <button id="applyMatrixFilterBtn" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-blue-700 transition-colors">Apply Filter</button>
                                <button id="clearMatrixFilterBtn" class="bg-slate-500 text-white font-semibold py-2 px-4 rounded-md hover:bg-slate-600 transition-colors">Clear Filters</button>
                            </div>
                            <p class="text-xs text-slate-500 mt-2">Note: For '% Change', enter numbers like 10 for 10% or -20 for -20%.</p>
                        </div>
                        <div id="matrixTableContainer" class="overflow-x-auto matrix-style-table-container">
                            <p class="text-slate-500 text-center py-16">Select metrics, products, and time periods, then click "Generate Matrix" to see the comparison table.</p>
                        </div>
                    </div>
                </div>

                <!-- AI Strategic Analysis Tab -->
                <div id="analysisTab" class="tab-content space-y-8">
                     <div class="card p-6">
                        <h2 class="text-2xl font-bold text-slate-900 mb-2">✨ AI-Powered Strategic Analysis</h2>
                        <p class="text-slate-600 mb-6">Get a high-level strategic analysis of your business performance, focusing on the health of your growth flywheel.</p>
                         <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 items-end">
                             <div>
                                <label for="analysisTimePeriodSelector" class="block text-sm font-medium text-slate-700 mb-1">Select Analysis Period:</label>
                                <select id="analysisTimePeriodSelector" class="w-full p-2 border border-slate-300 rounded-md shadow-sm">
                                    <option value="28" selected>Last 4 Weeks</option>
                                    <option value="91">Last Quarter</option>
                                    <option value="182">Last 6 Months</option>
                                </select>
                             </div>
                             <div class="self-end">
                                <button id="generateAnalysisBtn" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 transition duration-300 w-full flex items-center justify-center">✨ Generate Analysis</button>
                             </div>
                         </div>
                        <div id="wbrContent" class="prose max-w-none mt-6 p-6 border border-slate-200 rounded-lg bg-slate-50 min-h-[200px]">
                            <p class="text-slate-500">Your strategic analysis will appear here...</p>
                        </div>
                     </div>
                </div>
            </div>
            <p id="lastUpdated" class="text-sm text-center text-slate-500 mt-6"></p>
        </div>
    </div>
    
    <!-- AI Modal -->
    <div id="aiModal" class="fixed inset-0 z-50 flex items-center justify-center hidden">
        <div class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-3xl mx-4">
            <div class="flex justify-between items-center border-b pb-3 mb-4">
                <h3 id="aiModalTitle" class="text-2xl font-bold text-slate-800">AI Analysis</h3>
                <button id="closeAiModal" class="text-slate-500 hover:text-slate-800 text-3xl">×</button>
            </div>
            <div id="aiModalContent" class="ai-modal-content">
                 <div id="aiLoading" class="flex flex-col items-center justify-center p-8">
                     <div class="loader"></div>
                     <p class="mt-4 text-slate-600">Generating insights...</p>
                 </div>
                 <div id="aiResponse" class="hidden"></div>
            </div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- Global Variables and Constants ---
    const charts = {};
    let fullDataset = [];
    let heliumData = [];
    let wholesaleDataset = [];
    let mappedIndices = {};
    let detectedDelimiter = ',';
    let productMap = {};
    let selectedProductFilters = [];
    let selectedWholesaleContacts = [];
    let currencySymbol = '£';
    let currentPlatform = '';
    let lastMatrixData = { rows: [], summary: {} };
    let activeMatrixFilterAsins = null;
    let moversFilteredAsins = null;
    let matrixPrimarySortMetric = null; 
    let matrixSortState = { key: null, periodIndex: null, direction: 'desc' };
    let moversSortState = { column: 'absoluteChange', direction: 'desc' };
    let declinersSortState = { column: 'absoluteChange', direction: 'asc' };
    let wholesaleBestSellersSortState = { column: 'revenue', direction: 'desc' };
    let wholesaleMoversSortState = { column: 'absoluteChange', direction: 'desc' };
    let wholesaleDeclinersSortState = { column: 'absoluteChange', direction: 'asc' };
    let mainAsinCompetitorsMap = new Map();
    let mainAsinKeywordsMap = new Map();
    let lastHoveredAsin = null;
    let dom = {};

    const formatDate = (date) => new Date(date).toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric', timeZone: 'UTC' });

    // --- DOM Element Cache ---
    dom = {
        platformSelector: document.getElementById('platformSelector'),
        mappingUI: document.getElementById('mappingUI'),
        skuSelector: document.getElementById('skuSelector'),
        skuDriverSelector: document.getElementById('skuDriverSelector'),
        skuFilterBtn: document.getElementById('skuFilterBtn'),
        analyzeSkuBtn: document.getElementById('analyzeSkuBtn'),
        tabContainer: document.getElementById('tabContainer'),
        productSearchInput: document.getElementById('productSearchInput'),
        productSearchDropdown: document.getElementById('productSearchDropdown'),
        productSearchPills: document.getElementById('productSearchPills'),
        timePeriodSelector: document.getElementById('timePeriodSelector'),
        pieChartTimeSelector: document.getElementById('pieChartTimeSelector'),
        pieChartMetricSelector: document.getElementById('pieChartMetricSelector'),
        pieChartProductSelector: document.getElementById('pieChartProductSelector'),
        pieTimeRangeText: document.getElementById('pieTimeRangeText'),
        salesPenetrationChartContainer: document.getElementById('salesPenetrationChartContainer'),
        generateAnalysisBtn: document.getElementById('generateAnalysisBtn'),
        analysisTimePeriodSelector: document.getElementById('analysisTimePeriodSelector'),
        wbrContent: document.getElementById('wbrContent'),
        moversTimeSelector: document.getElementById('moversTimeSelector'),
        moversMetricSelector: document.getElementById('moversMetricSelector'),
        topMoversTableContainer: document.getElementById('topMoversTableContainer'),
        topDeclinersTableContainer: document.getElementById('topDeclinersTableContainer'),
        flywheelAsinSelector: document.getElementById('flywheelAsinSelector'),
        flywheelTimeSelector: document.getElementById('flywheelTimeSelector'),
        mainAsinFilterSelector: document.getElementById('mainAsinFilterSelector'),
        keywordFilterSelector: document.getElementById('keywordFilterSelector'),
        rankTypeSelector: document.getElementById('rankTypeSelector'),
        rankingStartDateInput: document.getElementById('rankingStartDate'),
        rankingEndDateInput: document.getElementById('rankingEndDate'),
        generateMatrixBtn: document.getElementById('generateMatrixBtn'),
        matrixMetricSelector: document.getElementById('matrixMetricSelector'),
        matrixAsinSelector: document.getElementById('matrixAsinSelector'),
        matrixTimePeriodSelector: document.getElementById('matrixTimePeriodSelector'),
        matrixTableContainer: document.getElementById('matrixTableContainer'),
        aiModal: document.getElementById('aiModal'),
        closeAiModalBtn: document.getElementById('closeAiModal'),
        aiModalTitle: document.getElementById('aiModalTitle'),
        aiModalContent: document.getElementById('aiModalContent'),
        aiLoading: document.getElementById('aiLoading'),
        aiResponse: document.getElementById('aiResponse'),
        errorLog: document.getElementById('errorLog'),
        loading: document.getElementById('loading'),
        dashboardContainer: document.getElementById('dashboardContainer'),
        lastUpdated: document.getElementById('lastUpdated'),
        mainTitle: document.getElementById('main-title'),
        mainSubtitle: document.getElementById('main-subtitle'),
        wholesaleStartDate: document.getElementById('wholesaleStartDate'),
        wholesaleEndDate: document.getElementById('wholesaleEndDate'),
        wholesaleContactSearchInput: document.getElementById('wholesaleContactSearchInput'),
        wholesaleContactSearchDropdown: document.getElementById('wholesaleContactSearchDropdown'),
        wholesaleContactSearchPills: document.getElementById('wholesaleContactSearchPills'),
        wholesaleShowAllContactsBtn: document.getElementById('wholesaleShowAllContactsBtn'),
        wholesaleWeekSelectorContainer: document.getElementById('wholesaleWeekSelectorContainer'),
        wholesaleBestSellersContainer: document.getElementById('wholesaleBestSellersContainer'),
        wholesaleMoversTimeRangeText: document.getElementById('wholesaleMoversTimeRangeText'),
        wholesaleTopMoversContainer: document.getElementById('wholesaleTopMoversContainer'),
        wholesaleTopDeclinersContainer: document.getElementById('wholesaleTopDeclinersContainer'),
        matrixFilterMetric: document.getElementById('matrixFilterMetric'),
        matrixFilterPeriod: document.getElementById('matrixFilterPeriod'),
        matrixFilterColumn: document.getElementById('matrixFilterColumn'),
        matrixFilterOperator: document.getElementById('matrixFilterOperator'),
        matrixFilterValue1: document.getElementById('matrixFilterValue1'),
        matrixFilterValue2: document.getElementById('matrixFilterValue2'),
        applyMatrixFilterBtn: document.getElementById('applyMatrixFilterBtn'),
        clearMatrixFilterBtn: document.getElementById('clearMatrixFilterBtn'),
        moversFilterMetric: document.getElementById('moversFilterMetric'),
        moversFilterPeriod: document.getElementById('moversFilterPeriod'),
        moversFilterColumn: document.getElementById('moversFilterColumn'),
        moversFilterOperator: document.getElementById('moversFilterOperator'),
        moversFilterValue1: document.getElementById('moversFilterValue1'),
        moversFilterValue2: document.getElementById('moversFilterValue2'),
        applyMoversFilterBtn: document.getElementById('applyMoversFilterBtn'),
        clearMoversFilterBtn: document.getElementById('clearMoversFilterBtn'),
    };
    
    const platformGids = {
        'UK': '1235928340',
        'DE': '86915241',
        'FR': '2004075615',
        'ES': '667607624',
        'CA': '1750593291',
    };
    const baseUrl = 'https://docs.google.com/spreadsheets/d/1XF9BNzL1qbnxxm8gknxlxdkg1HFPa9wr2px9vuGUOQk/export?format=csv&gid=';

    function setupPlatformSelector() {
        dom.platformSelector.addEventListener('click', (e) => {
            if (e.target.matches('.platform-btn')) {
                const platform = e.target.dataset.platform;
                dom.platformSelector.style.display = 'none';
                loadDataFromCloud(platform);
            }
        });
    }

    async function loadDataFromCloud(platform) {
        currentPlatform = platform;
        dom.loading.classList.remove('hidden');
        dom.dashboardContainer.classList.add('hidden');
        dom.errorLog.classList.add('hidden');
        
        try {
            if (platform === 'WHOLESALE') {
                currencySymbol = '£';
                dom.mainTitle.textContent = `Wholesale Sales Dashboard`;
                dom.mainSubtitle.textContent = `Analysis of sales by contact and product.`;
                
                const url = 'https://docs.google.com/spreadsheets/d/1XF9BNzL1qbnxxm8gknxlxdkg1HFPa9wr2px9vuGUOQk/export?format=csv&gid=53225596';
                const proxy = 'https://cors-anywhere.herokuapp.com/';
                const response = await fetch(proxy + url);
                const wholesaleDataText = await response.text();
                document.getElementById('wholesaleData').value = wholesaleDataText;
                
                processWholesaleData();
                setupWholesaleUI();

            } else { // It's an Amazon platform
                const proxy = 'https://cors-anywhere.herokuapp.com/';
                let mainDataText = '';
                
                if (platform === 'EU_CONSOLIDATED') {
                    currencySymbol = '€';
                    dom.mainTitle.textContent = `Amazon Performance Dashboard - Consolidated EU`;

                    // First, fetch UK data just to build the English product title map
                    const ukResponse = await fetch(proxy + baseUrl + platformGids['UK']);
                    if (!ukResponse.ok) throw new Error(`Failed to fetch UK data for product titles: ${ukResponse.statusText}`);
                    const ukDataText = await ukResponse.text();
                    buildEnglishProductMap(ukDataText);
                    
                    const euPlatforms = ['DE', 'FR', 'ES'];
                    const promises = euPlatforms.map(p => fetch(proxy + baseUrl + platformGids[p]));
                    const responses = await Promise.all(promises);

                    for (const response of responses) {
                        if (!response.ok) {
                            throw new Error(`Failed to fetch data for one of the EU platforms: ${response.statusText}`);
                        }
                    }

                    let combinedCsvRows = [];
                    for (let i = 0; i < responses.length; i++) {
                        const text = await responses[i].text();
                        const lines = text.trim().split(/\r\n|\n|\r/);
                        if (i === 0) {
                            combinedCsvRows.push(lines[0]);
                        }
                        combinedCsvRows.push(...lines.slice(1));
                    }
                    mainDataText = combinedCsvRows.join('\n');
                    
                } else {
                    currencySymbol = ['DE', 'FR', 'ES'].includes(platform) ? '€' : '£';
                    dom.mainTitle.textContent = `Amazon Performance Dashboard - ${platform}`;
                    const mainResponse = await fetch(proxy + baseUrl + platformGids[platform]);
                     if (!mainResponse.ok) throw new Error(`Failed to fetch data for ${platform}: ${mainResponse.statusText}`);
                    mainDataText = await mainResponse.text();
                }

                dom.mainSubtitle.textContent = `Your AI-powered command center for sales and advertising analysis.`;

                const rankResponse = await fetch(proxy + 'https://docs.google.com/spreadsheets/d/1XF9BNzL1qbnxxm8gknxlxdkg1HFPa9wr2px9vuGUOQk/export?format=csv&gid=329048601');
                const rankDataText = await rankResponse.text();
                
                document.getElementById('csvData').value = mainDataText;
                document.getElementById('combinedRankData').value = rankDataText;

                const headerLine = mainDataText.trim().split(/\r\n|\n|\r/)[0];
                const commaCount = (headerLine.match(/,/g) || []).length;
                const semicolonCount = (headerLine.match(/;/g) || []).length;
                detectedDelimiter = semicolonCount > commaCount ? ';' : ',';
                const header = parseCsvRow(headerLine, detectedDelimiter);
                
                generateMappingUI(header);
                
                mappedIndices = {};
                document.querySelectorAll('#mappingUI select').forEach(select => {
                    const key = select.dataset.key;
                    const index = parseInt(select.value, 10);
                    mappedIndices[key] = index;
                });
                
                processAllData();
                setupAmazonUI(platform);
                rerenderAllCharts();
            }

        } catch (error) {
            console.error("Dashboard Error:", error);
            showError(`An error occurred while fetching data from the cloud: ${error.message}. Please ensure Google Sheet GIDs are correct, that sharing is set to 'Anyone with the link', and that the CORS proxy is active.`);
        } finally {
            dom.loading.classList.add('hidden');
            dom.dashboardContainer.classList.remove('hidden');
            dom.lastUpdated.textContent = `Last updated: ${new Date().toLocaleString()}`;
        }
    }
    
    function setupAmazonUI(platform) {
        document.querySelector('.tab-button[data-tab="deepdive"]').style.display = 'block';
        document.querySelector('.tab-button[data-tab="matrix"]').style.display = 'block';
        document.querySelector('.tab-button[data-tab="analysis"]').style.display = 'block';
        document.querySelector('.tab-button[data-tab="wholesale"]').style.display = 'none';

        const rankingSection = document.getElementById('rankingAnalysisSection');
        if (rankingSection) {
            rankingSection.style.display = platform === 'EU_CONSOLIDATED' ? 'none' : 'block';
        }
        
        document.querySelector('.tab-button[data-tab="deepdive"]').click();
    }

    function setupWholesaleUI() {
        document.querySelector('.tab-button[data-tab="deepdive"]').style.display = 'none';
        document.querySelector('.tab-button[data-tab="matrix"]').style.display = 'none';
        document.querySelector('.tab-button[data-tab="analysis"]').style.display = 'none';
        document.querySelector('.tab-button[data-tab="wholesale"]').style.display = 'block';

        document.querySelector('.tab-button[data-tab="wholesale"]').click();
        
        const endDate = new Date();
        const startDate = new Date();
        startDate.setMonth(startDate.getMonth() - 6);
        dom.wholesaleStartDate.value = startDate.toISOString().split('T')[0];
        dom.wholesaleEndDate.value = endDate.toISOString().split('T')[0];
        
        const debouncedRender = debounce(renderWholesaleDashboard, 300);
        
        dom.wholesaleStartDate.addEventListener('change', debouncedRender);
        dom.wholesaleEndDate.addEventListener('change', debouncedRender);

        setupWholesaleContactFilter();
        rerenderAllCharts();
    }

    function debounce(func, delay) {
        let timeout;
        return function(...args) {
            const context = this;
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(context, args), delay);
        };
    }

    setupPlatformSelector();
    
    function rerenderAllCharts() {
        const activeTabEl = document.querySelector('.tab-button.active');
        if (!activeTabEl) return; 
        
        const activeTab = activeTabEl.dataset.tab;
        if (activeTab === 'deepdive') {
            renderDeepDiveDashboardContent();
        } else if (activeTab === 'wholesale') {
            renderWholesaleDashboard();
        }
    }

    function getDisplayTitle(asin) {
        const baseTitle = productMap[asin] || asin;
        if (currentPlatform === 'EU_CONSOLIDATED') {
            return `EU Total + ${baseTitle}`;
        }
        return baseTitle;
    }

    function getPeriodData(data, startDate, endDate) {
        const periodData = data.filter(d => d.date && d.date >= startDate && d.date <= endDate);
        
        const totals = periodData.reduce((acc, row) => {
            acc.revenue += row.revenue || 0;
            acc.units += row.units || 0;
            acc.adSpend += row.adSpend || 0;
            acc.adSales += row.adSales || 0;
            acc.glanceViews += row.glanceViews || 0;
            acc.impressions += row.impressions || 0;
            acc.clicks += row.clicks || 0;
            return acc;
        }, {
            revenue: 0, units: 0, adSpend: 0, adSales: 0, glanceViews: 0,
            impressions: 0, clicks: 0
        });

        const averageOos = periodData.length > 0 ? periodData.reduce((sum, row) => sum + (row.oos || 0), 0) / periodData.length : 0;
        const averageProcOos = periodData.length > 0 ? periodData.reduce((sum, row) => sum + (row.procOos || 0), 0) / periodData.length : 0;
        
        const adOrders = periodData.reduce((sum, row) => {
            if (row.adSales > 0 && row.revenue > 0) {
                return sum + row.units * (row.adSales / row.revenue);
            }
            return sum;
        }, 0);

        return {
            revenue: totals.revenue,
            units: totals.units,
            adSpend: totals.adSpend,
            adSales: totals.adSales,
            glanceViews: totals.glanceViews,
            impressions: totals.impressions,
            clicks: totals.clicks,
            oos: averageOos,
            procOos: averageProcOos,
            organicSales: totals.revenue - totals.adSales,
            acos: totals.adSales > 0 ? totals.adSpend / totals.adSales : 0,
            tacos: totals.revenue > 0 ? totals.adSpend / totals.revenue : 0,
            roas: totals.adSpend > 0 ? totals.adSales / totals.adSpend : 0,
            ctr: totals.impressions > 0 ? totals.clicks / totals.impressions : 0,
            cpc: totals.clicks > 0 ? totals.adSpend / totals.clicks : 0,
            conversionRate: totals.glanceViews > 0 ? totals.units / totals.glanceViews : 0,
            adConversionRate: totals.clicks > 0 ? adOrders / totals.clicks : 0,
            adSalesRatio: totals.revenue > 0 ? totals.adSales / totals.revenue : 0,
            asp: totals.units > 0 ? totals.revenue / totals.units : 0,
        };
    }

    function processAllData() {
        processData();
        processCombinedRankData();
        
        if (fullDataset.length === 0) {
            throw new Error("No valid data rows could be processed from the main sales data file. Please check your data and mappings, especially the 'Date' column format.");
        }

        populateSelectors();
        setupProductSearch();
    }

    dom.skuSelector.addEventListener('change', (event) => renderSkuDashboard(event.target.value, true));
    dom.skuDriverSelector.addEventListener('change', () => renderDriverChart());
    dom.skuFilterBtn.addEventListener('click', () => {
        const selectedAsin = dom.skuSelector.value;
        renderSkuDashboard(selectedAsin, false);
    });
    dom.analyzeSkuBtn.addEventListener('click', handleSkuAnalysis);
    dom.generateAnalysisBtn.addEventListener('click', handleStrategicAnalysis);

    dom.tabContainer.addEventListener('click', (e) => {
        if (e.target.matches('.tab-button')) {
            const tab = e.target.dataset.tab;
            dom.tabContainer.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            e.target.classList.add('active');
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(`${tab}Tab`).classList.add('active');
            rerenderAllCharts();
        }
    });

    dom.timePeriodSelector.addEventListener('change', () => renderDeepDiveDashboardContent());
    dom.pieChartTimeSelector.addEventListener('change', () => renderSalesMixChart());
    dom.pieChartMetricSelector.addEventListener('change', () => renderSalesMixChart());
    dom.pieChartProductSelector.addEventListener('change', () => renderSalesMixChart());
    
    dom.moversTimeSelector.addEventListener('change', () => renderMoversAndDecliners());
    dom.moversMetricSelector.addEventListener('change', () => renderMoversAndDecliners());
    dom.topMoversTableContainer.addEventListener('click', (e) => handleMoversSort(e, 'movers'));
    dom.topDeclinersTableContainer.addEventListener('click', (e) => handleMoversSort(e, 'decliners'));


    dom.flywheelAsinSelector.addEventListener('change', () => renderFlywheelDiagnosis());
    dom.flywheelTimeSelector.addEventListener('change', () => renderFlywheelDiagnosis());

    const updateRankingView = () => renderCompetitorRankingChart();
    dom.mainAsinFilterSelector.addEventListener('change', () => {
        populateKeywordFilter();
        updateRankingView();
    });
    dom.keywordFilterSelector.addEventListener('change', updateRankingView);
    dom.rankTypeSelector.addEventListener('change', updateRankingView);
    dom.rankingStartDateInput.addEventListener('change', updateRankingView);
    dom.rankingEndDateInput.addEventListener('change', updateRankingView);

    dom.generateMatrixBtn.addEventListener('click', renderMatrixTable);

    dom.matrixTableContainer.addEventListener('click', (e) => {
        const metricSelector = e.target.closest('.sort-metric-selector');
        if (metricSelector) {
            matrixPrimarySortMetric = metricSelector.dataset.metricKey;
            drawMatrixTableFromData(activeMatrixFilterAsins); 
            return;
        }

        const header = e.target.closest('.sortable-header');
        if (header) {
            const sortKey = header.dataset.sortKey;
            const periodIndex = header.dataset.periodIndex ? parseInt(header.dataset.periodIndex, 10) : null;

            if (matrixSortState.key === sortKey && matrixSortState.periodIndex === periodIndex) {
                matrixSortState.direction = matrixSortState.direction === 'desc' ? 'asc' : 'desc';
            } else {
                matrixSortState.key = sortKey;
                matrixSortState.periodIndex = periodIndex;
                matrixSortState.direction = 'desc';
            }
            
            const primaryMetricKey = matrixPrimarySortMetric || dom.matrixMetricSelector.selectedOptions[0]?.value;
            if (!primaryMetricKey) return; 
            
            const asinsToSort = activeMatrixFilterAsins ? [...activeMatrixFilterAsins] : [...new Set(lastMatrixData.rows.map(r => r.asin))];

            asinsToSort.sort((asinA, asinB) => {
                const rowA = lastMatrixData.rows.find(r => r.asin === asinA && r.metricKey === primaryMetricKey);
                const rowB = lastMatrixData.rows.find(r => r.asin === asinB && r.metricKey === primaryMetricKey);

                if (!rowA || !rowB) return 0;

                let valA, valB;
                if (periodIndex !== null) {
                    valA = rowA.periods[periodIndex][sortKey];
                    valB = rowB.periods[periodIndex][sortKey];
                } else { 
                    valA = rowA[sortKey];
                    valB = rowB[sortKey];
                }
                
                const isAFinite = Number.isFinite(valA);
                const isBFinite = Number.isFinite(valB);
                if (isAFinite && !isBFinite) return -1;
                if (!isAFinite && isBFinite) return 1;
                if (!isAFinite && !isBFinite) return 0;

                let comparison = 0;
                if (matrixSortState.direction === 'desc') {
                    comparison = valB - valA;
                } else {
                    comparison = valA - valB;
                }
                
                if (comparison !== 0) return comparison;
                return (productMap[asinA] || asinA).localeCompare(productMap[asinB] || asinB);
            });

            drawMatrixTableFromData(asinsToSort);
        }
    });


    dom.matrixFilterOperator.addEventListener('change', () => {
        if (dom.matrixFilterOperator.value === 'between') {
            dom.matrixFilterValue2.classList.remove('hidden');
        } else {
            dom.matrixFilterValue2.classList.add('hidden');
        }
    });
    dom.applyMatrixFilterBtn.addEventListener('click', applyMatrixFilters);
    dom.clearMatrixFilterBtn.addEventListener('click', () => clearMatrixFilters(true));

    dom.moversFilterOperator.addEventListener('change', () => {
        if (dom.moversFilterOperator.value === 'between') {
            dom.moversFilterValue2.classList.remove('hidden');
        } else {
            dom.moversFilterValue2.classList.add('hidden');
        }
    });
    dom.applyMoversFilterBtn.addEventListener('click', applyMoversFilter);
    dom.clearMoversFilterBtn.addEventListener('click', () => clearMoversFilter(true));

    dom.closeAiModalBtn.addEventListener('click', () => dom.aiModal.classList.add('hidden'));
    dom.aiModal.addEventListener('click', (e) => {
        if (e.target === dom.aiModal) dom.aiModal.classList.add('hidden');
    });

    function getWeekKey(date) {
        const d = new Date(date);
        d.setUTCHours(0,0,0,0);
        const day = d.getUTCDay(); // 0 = Sunday
        const diffToMonday = d.getUTCDate() - day + (day === 0 ? -6 : 1);
        const weekStart = new Date(d.setUTCDate(diffToMonday));
        return weekStart.toISOString().split('T')[0];
    }

    function parseCsvRow(rowString, delimiter) {
        const row = [];
        let currentField = '';
        let inQuotedField = false;
        for (let i = 0; i < rowString.length; i++) {
            const char = rowString[i];
            if (char === '"' && (i === 0 || rowString[i - 1] !== '\\')) {
                if (inQuotedField && rowString[i + 1] === '"') {
                    currentField += '"';
                    i++;
                } else {
                    inQuotedField = !inQuotedField;
                }
            } else if (char === delimiter && !inQuotedField) {
                row.push(currentField.trim().replace(/^"|"$/g, ''));
                currentField = '';
            } else {
                currentField += char;
            }
        }
        row.push(currentField.trim().replace(/^"|"$/g, ''));
        return row;
    }
    
    function parseFullCsv(csvText, delimiter = ',') {
        const rows = [];
        let currentRow = [];
        let currentField = '';
        let inQuotedField = false;
        csvText += '\n'; // Ensure the last row is processed

        for (let i = 0; i < csvText.length; i++) {
            const char = csvText[i];
            
            if (inQuotedField) {
                if (char === '"') {
                    if (csvText[i + 1] === '"') { // Escaped quote ""
                        currentField += '"';
                        i++; // Skip next quote
                    } else { // End of quoted field
                        inQuotedField = false;
                    }
                } else {
                    currentField += char;
                }
            } else {
                if (char === '"') {
                    inQuotedField = true;
                } else if (char === delimiter) {
                    currentRow.push(currentField);
                    currentField = '';
                } else if (char === '\n' || char === '\r') {
                    if (char === '\r' && csvText[i + 1] === '\n') i++; // Handle CRLF
                    currentRow.push(currentField);
                    rows.push(currentRow);
                    currentRow = [];
                    currentField = '';
                } else {
                    currentField += char;
                }
            }
        }
        return rows.filter(row => row.length > 1 || (row.length === 1 && row[0] !== ''));
    }

    function generateMappingUI(header) {
        const fields = {
            date: 'Date *', asin: 'ASIN *', productTitle: 'Product Title', category: 'Category',
            revenue: 'Revenue *', units: 'Units Sold *',
            adSpend: 'Ad Spend', adSales: 'Ad Sales', glanceViews: 'Glance Views',
            conversionRate: 'Conversion Rate', impressions: 'Impressions', clicks: 'Clicks',
            cpc: 'Cost per click', oos: 'Rep OOS - % of Total', procOos: 'Procurable Product OOS',
            sellableUnits: 'Sellable On Hand Units', unhealthyUnits: 'Unhealthy Units'
        };
        
        dom.mappingUI.innerHTML = '';
        Object.entries(fields).forEach(([key, label]) => {
            const isRequired = label.includes('*');
            const selectId = `map-${key}`; 
            let options = `<option value="-1">-- ${isRequired ? 'Select Column' : 'Optional'} --</option>`;
            header.forEach((h, i) => { options += `<option value="${i}">${h.trim()}</option>`; });
            dom.mappingUI.innerHTML += `<div><label for="${selectId}" class="block text-sm font-medium text-slate-700">${label.replace(' *', '')} ${isRequired ? '<span class="text-red-500">*</span>' : ''}</label><select id="${selectId}" data-key="${key}" class="mt-1 block w-full p-2 border border-slate-300 rounded-md shadow-sm">${options}</select></div>`;
        });

        const autoMap = {
            date: "Date", asin: "ASIN", productTitle: "Product Title", category: "Category",
            revenue: "Ordered Revenue", units: "Ordered Units", adSpend: "Marketing Spend",
            adSales: "Sales from Sponsored Ad", glanceViews: "Glance views", conversionRate: "Conversion rate",
            impressions: "Impressions", clicks: "Clicks", cpc: "Cost per click", oos: "Rep OOS - % of Total",
            procOos: "Procurable Product OOS", sellableUnits: "Sellable On Hand Units", unhealthyUnits: "Unhealthy Units"
        };
        
        Object.entries(autoMap).forEach(([key, headerText]) => {
            const select = document.querySelector(`#mappingUI #map-${key}`);
            if (select) {
                const option = Array.from(select.options).find(opt => opt.text.toLowerCase().trim() === headerText.toLowerCase().trim());
                if (option) {
                     select.value = option.value;
                }
            }
        });
    }

    function showError(message) {
        dom.errorLog.innerHTML = `<p class="font-bold">An error occurred:</p><p>${message}</p>`;
        dom.errorLog.classList.remove('hidden');
        window.scrollTo({ top: dom.errorLog.offsetTop - 20, behavior: 'smooth' });
    }

    function cleanNumber(value) {
        if (typeof value !== 'string' || value.trim() === '') return 0;

        let cleaned = value.trim().replace(/[£$€\s]/g, ''); 
        const hasPercent = cleaned.endsWith('%');
        if (hasPercent) {
            cleaned = cleaned.slice(0, -1);
        }
        
        const lastComma = cleaned.lastIndexOf(',');
        const lastPeriod = cleaned.lastIndexOf('.');

        if (lastComma > lastPeriod) {
            cleaned = cleaned.replace(/\./g, '').replace(',', '.');
        } else if (lastPeriod > lastComma) {
            cleaned = cleaned.replace(/,/g, '');
        } else {
            cleaned = cleaned.replace(',', '.');
        }

        const num = parseFloat(cleaned);
        if (isNaN(num)) return 0;
        
        return hasPercent ? num / 100 : num;
    }


    function cleanRank(value) {
        if (typeof value !== 'string' || value.trim() === '') return null;
        let cleaned = value.trim().replace('>', '');
        const num = parseInt(cleaned, 10);
        return isNaN(num) ? null : num;
    }

    function parseAsDate(value) {
        if (!value || typeof value !== 'string') return null;
        const trimmedValue = value.trim();
        let match;

        match = trimmedValue.match(/^(\d{4})-(\d{2})-(\d{2})/);
        if (match) {
            const [_, year, month, day] = match.map(Number);
            const d = new Date(Date.UTC(year, month - 1, day));
            if (!isNaN(d) && d.getUTCFullYear() === year && d.getUTCMonth() === month - 1 && d.getUTCDate() === day) return d;
        }

        match = trimmedValue.match(/^(\d{2})\/(\d{2})\/(\d{4})/);
        if (match) {
            const [_, day, month, year] = match.map(Number);
            const d = new Date(Date.UTC(year, month - 1, day));
            if (!isNaN(d) && d.getUTCFullYear() === year && d.getUTCMonth() === month - 1 && d.getUTCDate() === day) return d;
        }
        
        match = trimmedValue.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})/);
        if (match) {
            const [_, month, day, year] = match.map(Number);
            const d = new Date(Date.UTC(year, month - 1, day));
            if (!isNaN(d) && d.getUTCFullYear() === year && d.getUTCMonth() === month - 1 && d.getUTCDate() === day) return d;
        }

        match = trimmedValue.match(/^(\d{2})\.(\d{2})\.(\d{4})/);
        if (match) {
            const [_, day, month, year] = match.map(Number);
            const d = new Date(Date.UTC(year, month - 1, day));
            if (!isNaN(d) && d.getUTCFullYear() === year && d.getUTCMonth() === month - 1 && d.getUTCDate() === day) return d;
        }

        const d = new Date(trimmedValue);
        if (!isNaN(d)) {
            return new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
        }
        
        console.warn(`Could not parse date: "${trimmedValue}"`);
        return null;
    }
    
    function buildEnglishProductMap(ukCsvText) {
        const tempMappedIndices = {};
        const header = parseCsvRow(ukCsvText.trim().split(/\r\n|\n|\r/)[0], ',');
        tempMappedIndices.asin = header.findIndex(h => h.toLowerCase().trim() === 'asin');
        tempMappedIndices.productTitle = header.findIndex(h => h.toLowerCase().trim() === 'product title');

        if (tempMappedIndices.asin === -1 || tempMappedIndices.productTitle === -1) {
            console.warn("Could not find ASIN or Product Title columns in UK data to build English title map.");
            return;
        }

        const rows = ukCsvText.trim().split(/\r\n|\n|\r/).slice(1);
        rows.forEach(line => {
             const row = parseCsvRow(line, ',');
             const asin = row[tempMappedIndices.asin];
             const title = row[tempMappedIndices.productTitle];
             if (asin && title && !productMap[asin]) {
                 productMap[asin] = title;
             }
        });
    }


    function processData() {
        const csvText = document.getElementById('csvData').value; 
        const rows = csvText.trim().split(/\r\n|\n|\r/).slice(1).filter(line => line.trim() !== '').map(line => parseCsvRow(line, detectedDelimiter));
        fullDataset = []; 
        if (currentPlatform !== 'EU_CONSOLIDATED') {
            productMap = {};
        }
        let invalidDateCount = 0;
        
        for(let i = 0; i < rows.length; i++) {
            try {
                const row = rows[i];
                const dataPoint = {
                    date: parseAsDate(row[mappedIndices.date]),
                    asin: row[mappedIndices.asin] || 'Unknown ASIN',
                    title: mappedIndices.productTitle > -1 ? (row[mappedIndices.productTitle] || row[mappedIndices.asin]) : row[mappedIndices.asin],
                    category: mappedIndices.category > -1 ? (row[mappedIndices.category] || 'Uncategorized') : 'Uncategorized',
                    revenue: cleanNumber(row[mappedIndices.revenue]),
                    units: cleanNumber(row[mappedIndices.units]),
                    adSpend: mappedIndices.adSpend > -1 ? cleanNumber(row[mappedIndices.adSpend]) : 0,
                    adSales: mappedIndices.adSales > -1 ? cleanNumber(row[mappedIndices.adSales]) : 0,
                    glanceViews: mappedIndices.glanceViews > -1 ? cleanNumber(row[mappedIndices.glanceViews]) : 0,
                    conversionRateRaw: mappedIndices.conversionRate > -1 ? cleanNumber(row[mappedIndices.conversionRate]) : 0,
                    impressions: mappedIndices.impressions > -1 ? cleanNumber(row[mappedIndices.impressions]) : 0,
                    clicks: mappedIndices.clicks > -1 ? cleanNumber(row[mappedIndices.clicks]) : 0,
                    cpc: mappedIndices.cpc > -1 ? cleanNumber(row[mappedIndices.cpc]) : 0,
                    oos: mappedIndices.oos > -1 ? cleanNumber(row[mappedIndices.oos]) : 0,
                    procOos: mappedIndices.procOos > -1 ? cleanNumber(row[mappedIndices.procOos]) : 0,
                    sellableUnits: mappedIndices.sellableUnits > -1 ? cleanNumber(row[mappedIndices.sellableUnits]) : 0,
                    unhealthyUnits: mappedIndices.unhealthyUnits > -1 ? cleanNumber(row[mappedIndices.unhealthyUnits]) : 0,
                };
                dataPoint.conversionRate = dataPoint.glanceViews > 0 && dataPoint.units > 0 && dataPoint.conversionRateRaw === 0 ? dataPoint.units / dataPoint.glanceViews : dataPoint.conversionRateRaw;
                
                if (dataPoint.date instanceof Date && !isNaN(dataPoint.date) && dataPoint.asin !== 'Unknown ASIN') {
                    fullDataset.push(dataPoint);
                    if (!productMap[dataPoint.asin]) { productMap[dataPoint.asin] = dataPoint.title; }
                } else if (!dataPoint.date) {
                    invalidDateCount++;
                }
            } catch (e) { console.warn(`Skipping malformed row ${i + 2}: ${e.message}`); }
        }

        if (invalidDateCount > 0) console.warn(`Skipped ${invalidDateCount} rows due to invalid or unparseable dates.`);
        fullDataset.sort((a, b) => a.date - b.date);
    }

    function processCombinedRankData() {
        const csvText = document.getElementById('combinedRankData').value;
        heliumData = []; 
        mainAsinCompetitorsMap = new Map();
        mainAsinKeywordsMap = new Map();

        if (!csvText.trim()) { console.warn("Combined ASIN Rank Data is empty."); return; }

        const rows = csvText.trim().split(/\r\n|\n|\r/);
        const header = parseCsvRow(rows.shift().toLowerCase(), ',');
        const idx = {
            timestamp: header.indexOf('timestamp'),
            keyword: header.indexOf('keyword'),
            mainAsin: header.indexOf('main_asin'),
            rankType: header.indexOf('rank_type'),
            productAsin: header.indexOf('product_asin'),
            rank: header.indexOf('rank'),
        };

        if (Object.values(idx).some(i => i === -1)) {
            showError("Could not find all required columns in Combined ASIN Rank Data.");
            return;
        }

        const dailyAggregations = {};
        rows.forEach(rowString => {
            if (!rowString.trim()) return;
            const row = parseCsvRow(rowString, ',');
            const date = parseAsDate(row[idx.timestamp]);
            if (!date) return;

            const dateKey = date.toISOString().split('T')[0];
            const keyword = row[idx.keyword];
            const productAsin = row[idx.productAsin];
            const rankType = row[idx.rankType].toLowerCase();
            const rank = cleanRank(row[idx.rank]);
            if (rank === null) return;
            
            const mainAsin = row[idx.mainAsin];
            if (!mainAsinCompetitorsMap.has(mainAsin)) {
                mainAsinCompetitorsMap.set(mainAsin, new Set());
                mainAsinKeywordsMap.set(mainAsin, new Set());
            }
            mainAsinCompetitorsMap.get(mainAsin).add(productAsin);
            mainAsinKeywordsMap.get(mainAsin).add(keyword);

            const aggKey = `${dateKey}|${productAsin}|${keyword}`;
            if (!dailyAggregations[aggKey]) {
                dailyAggregations[aggKey] = { organic: [], sponsored: [] };
            }
            if (rankType === 'organic') {
                dailyAggregations[aggKey].organic.push(rank);
            } else if (rankType === 'sponsored') {
                dailyAggregations[aggKey].sponsored.push(rank);
            }
        });

        for (const aggKey in dailyAggregations) {
            const [dateKey, asin, keyword] = aggKey.split('|');
            const ranks = dailyAggregations[aggKey];
            const avgRank = (rankArr) => rankArr.length > 0 ? rankArr.reduce((a, b) => a + b, 0) / rankArr.length : null;
            
            const avgOrganic = avgRank(ranks.organic);
            const avgSponsored = avgRank(ranks.sponsored);
            
            if (avgOrganic !== null || avgSponsored !== null) {
                heliumData.push({ 
                    date: new Date(dateKey + 'T00:00:00Z'), 
                    asin, 
                    keyword,
                    organicRank: avgOrganic, 
                    sponsoredRank: avgSponsored 
                });
            }
        }
        heliumData.sort((a, b) => a.date - b.date);
    }
    
    function processWholesaleData() {
        const csvText = document.getElementById('wholesaleData').value;
        wholesaleDataset = [];
        if (!csvText.trim()) { 
            console.warn("Wholesale data is empty."); 
            const wholesaleTabButton = document.querySelector('.tab-button[data-tab="wholesale"]');
            if(wholesaleTabButton) wholesaleTabButton.style.display = 'none';
            return; 
        }

        const rows = csvText.trim().split(/\r\n|\n|\r/);
        rows.shift(); // Remove header row

        const idx = {
            contactName: 0,  // Column A
            invoiceDate: 3,  // Column D
            itemCode: 5,     // Column F
            description: 6,  // Column G
            quantity: 7,     // Column H
            salesValue: 10   // Column K
        };
        
        const firstDataRow = rows.find(r => r.trim() !== '');
        let wholesaleDelimiter = ',';
        if (firstDataRow) {
            const commaCount = (firstDataRow.match(/,/g) || []).length;
            const semicolonCount = (firstDataRow.match(/;/g) || []).length;
            if (semicolonCount > commaCount && semicolonCount > 5) {
                wholesaleDelimiter = ';';
            }
        }

        rows.forEach(line => {
            if (!line.trim()) return;
            const row = parseCsvRow(line, wholesaleDelimiter);
            
            if (row.length <= Math.max(...Object.values(idx))) {
                console.warn("Skipping malformed wholesale row:", row);
                return;
            }

            const date = parseAsDate(row[idx.invoiceDate]);
            if (!date) {
                console.warn("Skipping wholesale row due to invalid date:", row);
                return;
            }
            
            wholesaleDataset.push({
                contactName: row[idx.contactName] || 'Unknown',
                date: date,
                itemCode: row[idx.itemCode],
                description: row[idx.description] || 'No Description',
                quantity: cleanNumber(row[idx.quantity]),
                salesValue: cleanNumber(row[idx.salesValue])
            });
        });

        if(wholesaleDataset.length === 0) {
             showError("No valid rows could be processed from the Wholesale Sales Data. Please check the data format and ensure it matches the required column structure.");
        }
    }

    function calculateChange(current, previous) { 
        if (previous === 0) return current > 0 ? Infinity : 0; 
        return ((current - previous) / Math.abs(previous)); 
    }

    function populateSelectors() {
        const asins = [...new Set(fullDataset.map(d => d.asin))].sort((a,b) => (productMap[a] || a).localeCompare(productMap[b] || b));
        const asinOptions = asins.map(asin => `<option value="${asin}" title="${getDisplayTitle(asin)}">${getDisplayTitle(asin)}</option>`).join('');
        
        dom.skuSelector.innerHTML = `<option value="OVERALL">-- All Products --</option>` + asinOptions;
        dom.pieChartProductSelector.innerHTML = asinOptions;
        dom.flywheelAsinSelector.innerHTML = asinOptions;
        
        if (typeof mainAsinCompetitorsMap !== 'undefined' && mainAsinCompetitorsMap.size > 0) {
            const mainAsinOptions = Array.from(mainAsinCompetitorsMap.keys())
                .sort((a, b) => (productMap[a] || a).localeCompare(productMap[b] || b))
                .map(mainAsin => `<option value="${mainAsin}">${getDisplayTitle(mainAsin)}</option>`)
                .join('');
            dom.mainAsinFilterSelector.innerHTML = `<option value="">-- Select a Group --</option>` + mainAsinOptions;
        }

        populateMatrixSelectors();
        populateMoversMetricSelector();
        populateMoversFilterSelectors();
    }
    
    function getPeriod(latestDate, periodValue) {
        const end = new Date(latestDate); let start = new Date(latestDate);
        if (periodValue === 'qtd') { start.setUTCMonth(Math.floor(start.getUTCMonth() / 3) * 3, 1); start.setUTCHours(0,0,0,0); } 
        else if (periodValue === 'ytd') { start.setUTCMonth(0, 1); start.setUTCHours(0,0,0,0); }
        else { start.setUTCDate(start.getUTCDate() - (parseInt(periodValue, 10) - 1)); }
        return { start, end };
    }

    function setupProductSearch() {
         dom.productSearchInput.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            if (!searchTerm) {
                dom.productSearchDropdown.classList.add('hidden');
                return;
            }
            const filteredProducts = Object.entries(productMap).filter(([asin, title]) => 
                !selectedProductFilters.includes(asin) && (title.toLowerCase().includes(searchTerm) || asin.toLowerCase().includes(searchTerm))
            );
            
            if (filteredProducts.length > 0) {
                dom.productSearchDropdown.innerHTML = filteredProducts.slice(0, 50).map(([asin, title]) => 
                    `<div class="p-2 hover:bg-slate-100 cursor-pointer" data-asin="${asin}" data-title="${title}">${getDisplayTitle(asin)}</div>`
                ).join('');
                dom.productSearchDropdown.classList.remove('hidden');
            } else {
                dom.productSearchDropdown.classList.add('hidden');
            }
        });

        dom.productSearchDropdown.addEventListener('click', (e) => {
            if (e.target && e.target.matches('div[data-asin]')) {
                const asin = e.target.dataset.asin;
                addPill(asin, e.target.dataset.title);
                dom.productSearchInput.value = '';
                dom.productSearchDropdown.classList.add('hidden');
            }
        });

        document.addEventListener('click', (e) => {
            const container = document.getElementById('productSearchContainer');
            if (container && !container.contains(e.target)) {
                dom.productSearchDropdown.classList.add('hidden');
            }
        });
    }

    function addPill(asin, title) {
        if (!selectedProductFilters.includes(asin)) {
            selectedProductFilters.push(asin);
            const pill = document.createElement('div');
            pill.className = 'search-pill';
            pill.dataset.asin = asin;
            pill.innerHTML = `<span>${getDisplayTitle(asin).substring(0,25)}</span><button>×</button>`;
            pill.querySelector('button').addEventListener('click', (e) => {
                e.stopPropagation();
                removePill(asin);
            });
            dom.productSearchPills.appendChild(pill);
            renderDeepDiveDashboardContent();
        }
    }

    function removePill(asin) {
        selectedProductFilters = selectedProductFilters.filter(p => p !== asin);
        const pillToRemove = dom.productSearchPills.querySelector(`div[data-asin="${asin}"]`);
        if (pillToRemove) {
            dom.productSearchPills.removeChild(pillToRemove);
        }
        renderDeepDiveDashboardContent();
    }

    function aggregateWeekly(data) {
        if (!data) return [];
        const weeklyMap = {};
        data.forEach(row => {
            if(!row.date) return;
            const weekKey = getWeekKey(row.date);
            if (!weeklyMap[weekKey]) weeklyMap[weekKey] = [];
            weeklyMap[weekKey].push(row);
        });

        const sortedWeeklyData = Object.entries(weeklyMap).map(([week, weekData]) => {
            const weekStartDate = new Date(week);
            const weekEndDate = new Date(weekStartDate.getTime() + 6 * 24 * 60 * 60 * 1000);
            const metrics = getPeriodData(weekData, weekStartDate, weekEndDate);
            metrics.organicSales = metrics.revenue - metrics.adSales;

            const asin = weekData.length > 0 ? weekData[0].asin : null;
            let averageOrganicRank = null;
            let averageSponsoredRank = null;
            
            const isSingleProductView = new Set(weekData.map(d => d.asin)).size === 1;

            if (isSingleProductView && asin && heliumData.length > 0) {
                const weekRankData = heliumData.filter(d =>
                    d.asin === asin &&
                    d.date >= weekStartDate &&
                    d.date <= weekEndDate
                );

                const organicRanks = weekRankData.map(d => d.organicRank).filter(r => r !== null && typeof r === 'number');
                if (organicRanks.length > 0) {
                    averageOrganicRank = organicRanks.reduce((a, b) => a + b, 0) / organicRanks.length;
                }

                const sponsoredRanks = weekRankData.map(d => d.sponsoredRank).filter(r => r !== null && typeof r === 'number');
                if (sponsoredRanks.length > 0) {
                    averageSponsoredRank = sponsoredRanks.reduce((a, b) => a + b, 0) / sponsoredRanks.length;
                }
            }
            
            return { 
                week, 
                ...metrics,
                organicRank: averageOrganicRank,
                sponsoredRank: averageSponsoredRank
            };
        }).sort((a,b) => new Date(a.week) - new Date(b.week));

        const movingAverages = calculateMovingAverage(sortedWeeklyData, 4);
        sortedWeeklyData.forEach((d, i) => {
            d.fourWeekMovingAverage = movingAverages[i];
        });
        
        return sortedWeeklyData;
    }


     function calculateMovingAverage(data, windowSize) {
        const result = [];
        for(let i=0; i < data.length; i++) {
            if (i < windowSize -1) {
                result.push(null); 
            } else {
                let sum = 0;
                for (let j=0; j < windowSize; j++) {
                    sum += data[i-j].revenue;
                }
                result.push(sum / windowSize);
            }
        }
        return result;
    }

    function renderDeepDiveDashboardContent() {
        renderKpis();
        renderSalesMixChart();
        renderMoversAndDecliners();
        renderRankingAnalysisSection();
        
        const asins = [...new Set(fullDataset.map(d => d.asin))];
        if (asins.length > 0) {
             const currentSku = dom.skuSelector.value || 'OVERALL';
             renderSkuDashboard(currentSku, true);
             renderFlywheelDiagnosis();
        }
    }

    function calculateWeeklyPenetration(asin, startDate, endDate) {
        const periodData = fullDataset.filter(d => d.date >= startDate && d.date <= endDate);
        const weeklyAggregates = {};
        periodData.forEach(row => {
            const weekKey = getWeekKey(row.date);
            if (!weeklyAggregates[weekKey]) {
                weeklyAggregates[weekKey] = { total: 0, product: 0 };
            }
            weeklyAggregates[weekKey].total += row.revenue;
            if (row.asin === asin) {
                weeklyAggregates[weekKey].product += row.revenue;
            }
        });
        const penetrationData = Object.entries(weeklyAggregates)
            .map(([week, revenues]) => ({
                week,
                penetration: (revenues.total > 0) ? (revenues.product / revenues.total) * 100 : 0
            }))
            .sort((a, b) => new Date(a.week) - new Date(b.week));
        return penetrationData;
    }

    function renderSalesPenetrationChart(asin) {
        if (asin === lastHoveredAsin) return;
        lastHoveredAsin = asin;

        const container = dom.salesPenetrationChartContainer;
        const titleEl = document.getElementById('salesPenetrationChartTitle');
        const canvasId = 'salesPenetrationChart';
        const timeSelector = dom.pieChartTimeSelector;
        const periodValue = timeSelector.value;
        const latestDate = new Date(Math.max(...fullDataset.map(d => d.date).filter(d => d instanceof Date)));
        if (isNaN(latestDate.getTime())) return;
        
        const { start, end } = getPeriod(latestDate, periodValue);
        const penetrationData = calculateWeeklyPenetration(asin, start, end);
        
        if (penetrationData.length === 0) {
            hideSalesPenetrationChart();
            return;
        }

        titleEl.textContent = `Weekly Sales Penetration for: ${getDisplayTitle(asin)}`;
        container.classList.remove('hidden');

        if (charts[canvasId]) charts[canvasId].destroy();
        charts[canvasId] = new Chart(document.getElementById(canvasId), {
            type: 'line',
            data: {
                labels: penetrationData.map(d => d.week),
                datasets: [{
                    label: '% of Total Revenue',
                    data: penetrationData.map(d => d.penetration),
                    borderColor: '#4f46e5',
                    backgroundColor: 'rgba(79, 70, 229, 0.1)',
                    fill: 'start',
                    tension: 0.3
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: { callbacks: { label: (c) => `Penetration: ${c.raw.toFixed(2)}%` } }
                },
                scales: {
                    x: { type: 'time', time: { unit: 'week' } },
                    y: {
                        beginAtZero: true,
                        title: { display: true, text: 'Penetration of Total Revenue' },
                        ticks: { callback: (v) => `${v.toFixed(0)}%` }
                    }
                }
            }
        });
    }

    function hideSalesPenetrationChart() {
        if (lastHoveredAsin === null) return;
        lastHoveredAsin = null;
        
        dom.salesPenetrationChartContainer.classList.add('hidden');
        const canvasId = 'salesPenetrationChart';
        if (charts[canvasId]) {
            charts[canvasId].destroy();
            delete charts[canvasId];
        }
    }


    function renderSalesMixChart() {
        const chartId = 'salesMixChart';
        if (!dom.pieChartTimeSelector) return;

        const metricKey = dom.pieChartMetricSelector.value;
        const option = dom.pieChartMetricSelector.querySelector(`option[value="${metricKey}"]`);
        const metricLabel = option ? option.textContent : '';
        
        const isCurrency = ['revenue', 'adSpend', 'adSales'].includes(metricKey);
        const isPercentage = ['acos', 'tacos'].includes(metricKey);
        const isRatio = ['roas'].includes(metricKey);
        const calculatedMetrics = ['roas', 'acos', 'tacos'];

        if (metricKey !== 'revenue') {
            hideSalesPenetrationChart();
        }
        
        const periodValue = dom.pieChartTimeSelector.value;
        const latestDate = new Date(Math.max(...fullDataset.map(d => d.date).filter(d => d instanceof Date)));
        if (isNaN(latestDate.getTime())) return;

        const { start, end } = getPeriod(latestDate, periodValue);
        dom.pieTimeRangeText.textContent = `${formatDate(start)} - ${formatDate(end)}`;
        
        const periodData = fullDataset.filter(d => d.date >= start && d.date <= end);
        const selectedAsins = Array.from(dom.pieChartProductSelector.selectedOptions).map(opt => opt.value);

        let productValues = {};

        if (calculatedMetrics.includes(metricKey)) {
            const productAggregates = periodData.reduce((acc, d) => {
                if (!acc[d.asin]) {
                    acc[d.asin] = { adSales: 0, adSpend: 0, revenue: 0 };
                }
                acc[d.asin].adSales += d.adSales;
                acc[d.asin].adSpend += d.adSpend;
                acc[d.asin].revenue += d.revenue;
                return acc;
            }, {});

            for (const asin in productAggregates) {
                const totals = productAggregates[asin];
                if (metricKey === 'roas') {
                    productValues[asin] = totals.adSpend > 0 ? totals.adSales / totals.adSpend : 0;
                } else if (metricKey === 'acos') {
                    productValues[asin] = totals.adSales > 0 ? totals.adSpend / totals.adSales : 0;
                } else if (metricKey === 'tacos') {
                    productValues[asin] = totals.revenue > 0 ? totals.adSpend / totals.revenue : 0;
                }
            }
        } else {
            productValues = periodData.reduce((acc, d) => {
                acc[d.asin] = (acc[d.asin] || 0) + d[metricKey];
                return acc;
            }, {});
        }

        let sortedProducts = Object.entries(productValues).sort((a, b) => b[1] - a[1]);

        if (selectedAsins.length > 0) {
            sortedProducts = sortedProducts.filter(([asin]) => selectedAsins.includes(asin));
        }

        const totalValue = sortedProducts.reduce((sum, [, value]) => sum + value, 0);

        let topProducts = sortedProducts;
        let otherValue = 0;
        let othersBreakdown = [];

        if (selectedAsins.length === 0 && sortedProducts.length > 9) {
            topProducts = sortedProducts.slice(0, 9);
            const otherProducts = sortedProducts.slice(9);
            if (!calculatedMetrics.includes(metricKey)) {
                otherValue = otherProducts.reduce((sum, [, value]) => sum + value, 0);
                othersBreakdown = otherProducts.sort((a, b) => b[1] - a[1]).slice(0, 5);
            }
        }
        
        const labels = topProducts.map(([asin]) => getDisplayTitle(asin));
        const data = topProducts.map(([, value]) => value);
        const asinsForChart = topProducts.map(([asin]) => asin);

        if (otherValue > 0) {
            labels.push('Others');
            data.push(otherValue);
            asinsForChart.push('OTHERS');
        }
        
        const backgroundColors = ['#4338ca', '#6d28d9', '#16a34a', '#dc2626', '#db2777', '#f97316', '#0891b2', '#64748b', '#ca8a04', '#0d9488'];

        if (charts[chartId]) {
            charts[chartId].destroy();
        }

        charts[chartId] = new Chart(document.getElementById(chartId), {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    label: metricLabel,
                    data: data,
                    backgroundColor: backgroundColors,
                    hoverOffset: 4,
                    borderColor: '#fff',
                    borderWidth: 2,
                }],
                asins: asinsForChart
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                onHover: (event, chartElement, chart) => {
                    if (chartElement.length > 0) {
                        const index = chartElement[0].index;
                        const asin = chart.data.asins[index];
                        if (metricKey === 'revenue' && asin && asin !== 'OTHERS') {
                            renderSalesPenetrationChart(asin);
                        } else {
                            hideSalesPenetrationChart();
                        }
                    } else {
                        hideSalesPenetrationChart();
                    }
                },
                plugins: {
                    legend: { position: 'right' },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.raw;
                                let formattedValue;
                                if (isCurrency) {
                                    formattedValue = `${currencySymbol}${value.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
                                } else if (isPercentage) {
                                    formattedValue = `${(value * 100).toFixed(2)}%`;
                                } else if (isRatio) {
                                    formattedValue = value.toFixed(2);
                                } else {
                                    formattedValue = value.toLocaleString();
                                }
                                
                                let percentageString = '';
                                if (!calculatedMetrics.includes(metricKey)) {
                                    const percentage = totalValue > 0 ? (value / totalValue * 100).toFixed(2) : 0;
                                    percentageString = ` (${percentage}%)`;
                                }

                                return `${label}: ${formattedValue}${percentageString}`;
                            },
                            afterBody: function(context) {
                                const label = context[0].label;
                                if (label === 'Others' && othersBreakdown.length > 0) {
                                    const breakdownLines = othersBreakdown.map(([asin, value]) => {
                                        const percentageOfTotal = totalValue > 0 ? (value / totalValue * 100).toFixed(2) : 0;
                                        const formattedValue = isCurrency 
                                            ? `${currencySymbol}${value.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}`
                                            : value.toLocaleString();
                                        return ` - ${getDisplayTitle(asin)}: ${formattedValue} (${percentageOfTotal}%)`;
                                    });
                                    return ['\n--- Top 5 in "Others" ---', ...breakdownLines];
                                }
                                return '';
                            }
                        }
                    },
                     datalabels: { display: false }
                }
            }
        });
    }


    function filterSkuDataByDate(data) {
        const startDateEl = document.getElementById('skuStartDate');
        const endDateEl = document.getElementById('skuEndDate');
        const startDate = startDateEl.value ? new Date(startDateEl.value + 'T00:00:00Z') : null;
        const endDate = endDateEl.value ? new Date(endDateEl.value + 'T00:00:00Z') : null;

        if (startDate && endDate && data) {
            return data.filter(d => { 
                const weekDate = new Date(d.week); 
                return weekDate >= startDate && weekDate <= endDate; 
            });
        }
        return data;
    }

    function renderKpis() {
        const container = document.getElementById('kpi-grid');
        if (!container) return;
        const dataToAnalyze = selectedProductFilters.length === 0 ? fullDataset : fullDataset.filter(d => selectedProductFilters.includes(d.asin));

        const latestDate = new Date(Math.max(...dataToAnalyze.map(d => d.date).filter(d => d instanceof Date)));
        if (isNaN(latestDate.getTime())) {
            container.innerHTML = '<p class="text-center col-span-4 text-slate-500">No data for selected filters.</p>';
            return;
        };
        
        const periodValue = dom.timePeriodSelector.value;
        const currentPeriod = getPeriod(latestDate, periodValue);
        
        document.getElementById('kpiTimeRangeText').textContent = `${formatDate(currentPeriod.start)} - ${formatDate(currentPeriod.end)}`;

        const duration = Math.round((currentPeriod.end - currentPeriod.start) / (1000 * 3600 * 24)) + 1;
        const priorPeriodStart = new Date(currentPeriod.start); priorPeriodStart.setUTCDate(priorPeriodStart.getUTCDate() - duration);
        const priorPeriodEnd = new Date(currentPeriod.start); priorPeriodEnd.setUTCDate(priorPeriodEnd.getUTCDate() - 1);
        const yoyPeriodStart = new Date(currentPeriod.start); yoyPeriodStart.setUTCFullYear(yoyPeriodStart.getUTCFullYear() - 1);
        const yoyPeriodEnd = new Date(currentPeriod.end); yoyPeriodEnd.setUTCFullYear(yoyPeriodEnd.getUTCFullYear() - 1);

        const current = getPeriodData(dataToAnalyze, currentPeriod.start, currentPeriod.end);
        const prior = getPeriodData(dataToAnalyze, priorPeriodStart, priorPeriodEnd);
        const yoy = getPeriodData(dataToAnalyze, yoyPeriodStart, yoyPeriodEnd);


        const naText = `<span class="text-xs text-slate-500">N/A</span>`;
        const formatCurrency = (val, dec = 2) => `${currencySymbol}${val.toLocaleString('en-GB', {minimumFractionDigits:dec, maximumFractionDigits:dec})}`;
        const formatNumber = (val) => val.toLocaleString('en-GB');
        
        const changeText = (currentVal, priorVal, isRate = false, isGoodWhenDown = false, isCurrency = false, isRatio = false) => {
            if (priorVal === 0 && currentVal === 0) return naText;
            if (priorVal === 0) return naText;

            const change = calculateChange(currentVal, priorVal);
            if (!isFinite(change)) return naText;

            let isGood = isGoodWhenDown ? (change <= 0) : (change >= 0);
            const sign = change >= 0 ? '▲' : '▼';
            const color = isGood ? 'text-emerald-600' : 'text-red-600';
            
            let absChangeHtml = '';
            const absChange = currentVal - priorVal;

            if (isRate) {
                 absChangeHtml = ` <span class="text-xs text-slate-500">(${(absChange * 100).toFixed(1)}p.p.)</span>`;
            } else if (isRatio) {
                absChangeHtml = ` <span class="text-xs text-slate-500">(${absChange.toFixed(2)})</span>`;
            } else {
                const formattedAbs = isCurrency ? formatCurrency(absChange, 2) : formatNumber(absChange);
                absChangeHtml = ` <span class="text-xs text-slate-500">(${formattedAbs})</span>`;
            }
            
            return `<span class="font-medium ${color}">${sign} ${(Math.abs(change)*100).toFixed(1)}%</span>${absChangeHtml}`;
        };

        const kpiDefinitions = {
            revenue: { title: 'Revenue', isCurrency: true, icon: '<path stroke-linecap="round" stroke-linejoin="round" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v.01" />', bg: 'bg-blue-100 text-blue-600' },
            units: { title: 'Units Sold', icon: '<path stroke-linecap="round" stroke-linejoin="round" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />', bg: 'bg-indigo-100 text-indigo-600' },
            adSpend: { title: 'Ad Spend', isCurrency: true, isGoodWhenDown: true, icon: '<path stroke-linecap="round" stroke-linejoin="round" d="M9 14l6-6m-5.5.5h.01m4.99 5h.01M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16l3.5-2 3.5 2 3.5-2 3.5 2z" />', bg: 'bg-orange-100 text-orange-600' },
            adSales: { title: 'Ad Sales', isCurrency: true, icon: '<path stroke-linecap="round" stroke-linejoin="round" d="M11 11V17M11 7h.01M4 7h16a2 2 0 012 2v8a2 2 0 01-2 2H4a2 2 0 01-2-2V9a2 2 0 012-2z" />', bg: 'bg-rose-100 text-rose-600' },
            acos: { title: 'ACoS', isRate: true, format: (v) => `${(v * 100).toFixed(2)}%`, isGoodWhenDown: true, icon: '<path stroke-linecap="round" stroke-linejoin="round" d="M16 8v8m-4-5v5m-4-2v2m-2 4h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />', bg: 'bg-red-100 text-red-600' },
            tacos: { title: 'TACOS', isRate: true, format: (v) => `${(v * 100).toFixed(2)}%`, isGoodWhenDown: true, icon: '<path stroke-linecap="round" stroke-linejoin="round" d="M9 8h6m-5 0a3 3 0 110 6H9l3 3m-3-6h6m6 1a9 9 0 11-18 0 9 9 0 0118 0z" />', bg: 'bg-amber-100 text-amber-600' },
            roas: { title: 'ROAS', isRatio: true, format: (v) => v.toFixed(2), icon: '<path stroke-linecap="round" stroke-linejoin="round" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />', bg: 'bg-emerald-100 text-emerald-600' },
            impressions: { title: 'Impressions', icon: '<path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0zM2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />', bg: 'bg-sky-100 text-sky-600' },
            clicks: { title: 'Clicks', icon: '<path stroke-linecap="round" stroke-linejoin="round" d="M15 15l-2 5L9 9l11 4-5 2z" />', bg: 'bg-cyan-100 text-cyan-600' },
            ctr: { title: 'CTR', isRate: true, format: (v) => `${(v * 100).toFixed(2)}%`, icon: '<path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />', bg: 'bg-fuchsia-100 text-fuchsia-600' },
            cpc: { title: 'Cost per Click', isCurrency: true, format: (v) => `${currencySymbol}${v.toFixed(2)}`, isGoodWhenDown: true, icon: '<path stroke-linecap="round" stroke-linejoin="round" d="M15 9a2 2 0 10-4 0v5a2 2 0 01-2 2h-3a2 2 0 01-2-2v-5a2 2 0 012-2h3a2 2 0 012 2v5a2 2 0 002 2h3a2 2 0 002-2v-5a2 2 0 00-2-2h-3z" />', bg: 'bg-pink-100 text-pink-600' },
            adConversionRate: { title: 'Ad CVR', isRate: true, format: (v) => `${(v * 100).toFixed(2)}%`, icon: '<path stroke-linecap="round" stroke-linejoin="round" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" />', bg: 'bg-lime-100 text-lime-600' },
            glanceViews: { title: 'Glance Views', icon: '<path stroke-linecap="round" stroke-linejoin="round" d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2h10a2 2 0 002-2v-1a2 2 0 012-2h1.945C21.055 7.158 16.888 4 12 4s-9.055 3.158-9.945 7z" />', bg: 'bg-purple-100 text-purple-600' },
            conversionRate: { title: 'Total CVR', isRate: true, format: (v) => `${(v * 100).toFixed(2)}%`, icon: '<path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z" />', bg: 'bg-teal-100 text-teal-600' },
            adSalesRatio: { title: 'Ad Sales %', isRate: true, format: (v) => `${(v * 100).toFixed(2)}%`, icon: '<path stroke-linecap="round" stroke-linejoin="round" d="M3 6l3 1m0 0l-3 9a5.002 5.002 0 006.001 0M6 7l3 9M6 7l6-2m6 2l3-1m-3 1l-3 9a5.002 5.002 0 006.001 0M18 7l3 9m-3-9l-6-2" />', bg: 'bg-rose-100 text-rose-600' },
            oos: { title: 'Procurable OOS', isRate: true, format: (v) => `${(v * 100).toFixed(2)}%`, isGoodWhenDown: true, icon: '<path stroke-linecap="round" stroke-linejoin="round" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636" />', bg: 'bg-zinc-100 text-zinc-600' },
        };
        
        Object.entries(kpiDefinitions).forEach(([key, d]) => {
            const el = document.querySelector(`#kpi-grid #kpi-${key}`);
            if (!el) return;

            const currentVal = current ? current[key] : 0;
            const priorVal = prior ? prior[key] : 0;
            const yoyVal = yoy ? yoy[key] : 0;

            const formattedValue = d.format ? d.format(currentVal) : (d.isCurrency ? formatCurrency(currentVal) : formatNumber(currentVal));

            const changePriorText = changeText(currentVal, priorVal, d.isRate, d.isGoodWhenDown, d.isCurrency, d.isRatio);
            const changeYoYText = changeText(currentVal, yoyVal, d.isRate, d.isGoodWhenDown, d.isCurrency, d.isRatio);

            el.innerHTML = `
                <div class="flex items-center mb-2">
                    <div class="p-2 rounded-lg ${d.bg}">
                       <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 ${d.bg.split(' ')[1]}" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">${d.icon}</svg>
                    </div>
                    <h4 class="ml-3 text-slate-500 font-semibold">${d.title}</h4>
                </div>
                <p class="text-3xl font-bold text-slate-800">${formattedValue}</p>
                <div class="flex justify-between text-sm mt-2 pt-2 border-t border-slate-100">
                    <span>vs Prior: ${changePriorText}</span>
                    <span>vs YoY: ${changeYoYText}</span>
                </div>`;
        });
    }

    function populateDriverSelector() {
        const drivers = {
            impressions: "Impressions",
            clicks: "Ad Clicks",
            ctr: "CTR",
            adConversionRate: "Ad CVR",
            tacos: "TACOS",
            acos: "ACOS",
            roas: "ROAS",
            glanceViews: "Glance Views",
            conversionRate: "Total CVR",
            asp: "Avg. Selling Price",
            adSpend: "Ad Spend",
            adSales: "Ad Sales",
            cpc: "Cost per Click",
            organicRank: "Organic Rank",
            sponsoredRank: "Sponsored Rank"
        };
        const selector = document.getElementById('skuDriverSelector');
        if (selector) {
            const selectedValues = [...selector.selectedOptions].map(opt => opt.value);
            
            const isOverall = dom.skuSelector.value === 'OVERALL';
            
            selector.innerHTML = Object.entries(drivers)
                .map(([key, label]) => {
                    const isDisabled = isOverall && (key === 'organicRank' || key === 'sponsoredRank');
                    return `<option value="${key}" ${selectedValues.includes(key) && !isDisabled ? 'selected' : ''} ${isDisabled ? 'disabled' : ''}>${label} ${isDisabled ? '(N/A for Overall)' : ''}</option>`
                }).join('');
        }
    }

    function renderSkuDashboard(asin, updateDates = true) {
        let dataToProcess;
        if (asin === 'OVERALL') {
            dataToProcess = fullDataset;
            dom.analyzeSkuBtn.innerHTML = '✨ Analyze Overall';
        } else {
            dataToProcess = fullDataset.filter(d => d.asin === asin);
            dom.analyzeSkuBtn.innerHTML = '✨ Analyze';
        }

        if (dataToProcess.length === 0) return;

        const weeklyData = aggregateWeekly(dataToProcess);
        
        if (updateDates && weeklyData.length > 0) {
            const minDate = new Date(weeklyData[0].week);
            const maxDate = new Date(weeklyData[weeklyData.length - 1].week);
            document.getElementById('skuStartDate').value = minDate.toISOString().split('T')[0];
            document.getElementById('skuEndDate').value = maxDate.toISOString().split('T')[0];
        }
        
        populateDriverSelector();
        renderDriverChart(); 
        
        const filteredWeeklyData = filterSkuDataByDate(weeklyData);
        renderSkuAdEfficiencyChart(filteredWeeklyData);
        renderSkuSalesCompositionChart(filteredWeeklyData);
        renderSkuPriceElasticityChart(filteredWeeklyData);
        renderSkuFunnelChart(filteredWeeklyData);
        renderSkuOosChart(filteredWeeklyData);

        document.getElementById('skuDashboard').classList.remove('hidden');
    }

    function renderDriverChart() {
        const selectedAsinOrOverall = dom.skuSelector.value;
        let sourceData;
        if (selectedAsinOrOverall === 'OVERALL') {
            sourceData = fullDataset;
        } else {
            sourceData = fullDataset.filter(d => d.asin === selectedAsinOrOverall);
        }
        renderGenericDriverChart('skuRevenueChart', sourceData, 'skuDriverSelector', filterSkuDataByDate);
    }

    function renderGenericDriverChart(canvasId, sourceData, driverSelectorId, dateFilterFn) {
        const chartId = canvasId;
        const weeklyData = aggregateWeekly(sourceData);
        const filteredWeeklyData = dateFilterFn(weeklyData);

        if (charts[chartId]) charts[chartId].destroy();
        if (!filteredWeeklyData || filteredWeeklyData.length === 0) return;
        
        const selectedDrivers = Array.from(document.getElementById(driverSelectorId).selectedOptions).map(opt => opt.value);
        const labels = filteredWeeklyData.map(d => d.week);

        const driverColors = ['#f97316', '#16a34a', '#dc2626', '#9333ea', '#64748b', '#0891b2', '#eab308', '#22c55e', '#f43f5e'];
        const yAxes = {
            y: { type: 'linear', position: 'left', title: { display: true, text: `Weekly Revenue (${currencySymbol})` } },
        };
        
        const datasets = [{
            type: 'bar',
            label: 'Weekly Revenue',
            data: filteredWeeklyData.map(d => d.revenue),
            backgroundColor: 'rgba(79, 70, 229, 0.7)',
            yAxisID: 'y'
        },{
            type: 'line',
            label: '4-Week Moving Average',
            data: filteredWeeklyData.map(d => d.fourWeekMovingAverage),
            borderColor: '#6d28d9',
            borderDash: [5, 5],
            yAxisID: 'y',
            tension: 0.3,
            pointRadius: 0
        }];

        let axisCount = 0;
        selectedDrivers.forEach((driverKey, index) => {
            const isPercentage = ['tacos', 'acos', 'conversionRate', 'ctr', 'adConversionRate'].includes(driverKey);
            const isCurrency = ['asp', 'cpc', 'adSpend', 'adSales'].includes(driverKey);
            const isRank = ['organicRank', 'sponsoredRank'].includes(driverKey);
            
            let axisId;
            if(isPercentage) axisId = 'y_percent';
            else if(isCurrency) axisId = 'y_currency';
            else if(isRank) axisId = 'y_rank';
            else axisId = `y_${driverKey}`;

            if(!yAxes[axisId]) {
                let axisConfig = {
                    type: 'linear',
                    position: axisCount % 2 === 0 ? 'right' : 'left',
                    offset: axisCount > 1, 
                    grid: { drawOnChartArea: false },
                    ticks: { color: driverColors[index % driverColors.length] },
                };

                if (isRank) {
                    axisConfig.title = { display: true, text: 'Rank (Lower is better)', color: '#64748b' };
                    axisConfig.reverse = true;
                } else {
                    axisConfig.title = { display: true, text: document.querySelector(`#${driverSelectorId} [value=${driverKey}]`).textContent.replace(' (N/A for Overall)', ''), color: driverColors[index % driverColors.length] };
                }

                yAxes[axisId] = axisConfig;
                axisCount++;
            }
            
            datasets.push({
                type: 'line',
                label: document.querySelector(`#${driverSelectorId} [value=${driverKey}]`).textContent.replace(' (N/A for Overall)', ''),
                data: filteredWeeklyData.map(d => d[driverKey]),
                borderColor: driverColors[index % driverColors.length],
                backgroundColor: driverColors[index % driverColors.length],
                tension: 0.3,
                yAxisID: axisId,
                pointRadius: 2,
                borderWidth: 2,
            });
        });

        charts[chartId] = new Chart(document.getElementById(chartId), {
            data: { labels, datasets },
            options: { 
                responsive: true, 
                maintainAspectRatio: false, 
                scales: yAxes, 
                interaction: { mode: 'index', intersect: false },
                plugins: { tooltip: { /* ... */ } }
            }
        });
    }

    function renderSkuAdEfficiencyChart(weeklyData) {
        const chartId = 'skuAdEfficiencyChart';
        if (charts[chartId]) charts[chartId].destroy();
        if (!weeklyData || weeklyData.length === 0) return;
        
        const labels = weeklyData.map(d => d.week);
        charts[chartId] = new Chart(document.getElementById(chartId), {
            type: 'line',
            data: {
                labels,
                datasets: [
                    { label: 'TACOS', data: weeklyData.map(d => d.tacos), borderColor: '#4f46e5', yAxisID: 'y' },
                    { label: 'ACoS', data: weeklyData.map(d => d.acos), borderColor: '#f97316', yAxisID: 'y', borderDash: [5,5] },
                    { label: 'ROAS', data: weeklyData.map(d => d.roas), borderColor: '#16a34a', yAxisID: 'y1', }
                ]
            },
            options: { 
                responsive: true, maintainAspectRatio: false, 
                scales: { 
                    x: { type: 'time', time: { unit: 'week' } }, 
                    y: { position: 'left', title: {display:true, text: 'Efficiency % (ACoS/TACOS)'}, ticks: { callback: v => `${(v * 100).toFixed(1)}%` } },
                    y1: { position: 'right', grid: {drawOnChartArea: false}, title: {display:true, text: 'ROAS'}, ticks: { callback: v => v.toFixed(2) } }
                },
                plugins: { 
                    tooltip: { 
                        callbacks: { 
                            label: (c) => {
                                if (c.dataset.label === 'ROAS') {
                                    return `${c.dataset.label}: ${c.raw.toFixed(2)}`;
                                }
                                return `${c.dataset.label}: ${(c.raw*100).toFixed(2)}%`;
                            } 
                        } 
                    } 
                } 
            }
        });
    }

    function renderSkuSalesCompositionChart(weeklyData) {
        const chartId = 'skuSalesCompositionChart';
        if (charts[chartId]) charts[chartId].destroy();
        if (!weeklyData || weeklyData.length === 0) return;
        
        const labels = weeklyData.map(d => d.week);
        charts[chartId] = new Chart(document.getElementById(chartId), {
            type: 'bar',
            data: {
                labels,
                datasets: [
                    { label: 'Organic Sales', data: weeklyData.map(d => d.organicSales), backgroundColor: '#4338ca' },
                    { label: 'Ad Sales', data: weeklyData.map(d => d.adSales), backgroundColor: '#a5b4fc' }
                ]
            },
            options: { responsive: true, maintainAspectRatio: false, scales: { x: { type: 'time', time: { unit: 'week' }, stacked: true }, y: { stacked: true, title: {display: true, text: `Revenue (${currencySymbol})`} } },
            plugins: { 
                tooltip: { 
                    callbacks: { 
                        title: (context) => `Week of: ${formatDate(context[0].label)}`,
                        label: (c) => `${c.dataset.label}: ${currencySymbol}${c.raw.toFixed(2)}`,
                        footer: (tooltipItems) => {
                            const dataIndex = tooltipItems[0].dataIndex;
                            const organic = tooltipItems[0].chart.data.datasets[0].data[dataIndex] || 0;
                            const ad = tooltipItems[0].chart.data.datasets[1].data[dataIndex] || 0;
                            const total = organic + ad;
                            if (total === 0) return ['Organic: 0.0%', 'Ad: 0.0%', `Total: ${currencySymbol}0.00`];
                            const organicPercent = (organic / total * 100).toFixed(1);
                            const adPercent = (ad / total * 100).toFixed(1);
                            return [
                                `Organic: ${organicPercent}%`,
                                `Ad: ${adPercent}%`,
                                `Total: ${currencySymbol}${total.toFixed(2)}`
                            ];
                        }
                    } 
                } 
            } }
        });
    }

    function renderSkuPriceElasticityChart(weeklyData) {
        const chartId = 'skuPriceElasticityChart';
        if (charts[chartId]) charts[chartId].destroy();
        if (!weeklyData || weeklyData.length === 0) return;
        
        const labels = weeklyData.map(d => d.week);
        charts[chartId] = new Chart(document.getElementById(chartId), {
            type: 'bar',
            data: {
                labels,
                datasets: [
                    { label: 'Units Sold', data: weeklyData.map(d => d.units), yAxisID: 'y', backgroundColor: '#16a34a' },
                    { label: 'Avg. Selling Price', data: weeklyData.map(d => d.asp), yAxisID: 'y1', type: 'line', borderColor: '#f43f5e' }
                ]
            },
            options: { responsive: true, maintainAspectRatio: false, scales: { x: { type: 'time', time: { unit: 'week' } }, y: { position: 'left', title: {display: true, text: 'Units Sold'}}, y1: { position: 'right', grid: {drawOnChartArea: false}, title: {display: true, text: `ASP (${currencySymbol})`}}},
            plugins: { tooltip: { callbacks: { label: (c) => `${c.dataset.label}: ${c.dataset.yAxisID === 'y1' ? currencySymbol : ''}${c.raw.toFixed(2)}` } } } }
        });
    }

    function renderSkuFunnelChart(weeklyData) {
        const chartId = 'skuFunnelChart';
        if (charts[chartId]) charts[chartId].destroy();
        if (!weeklyData || weeklyData.length === 0) return;
        
        const labels = weeklyData.map(d => d.week);
        charts[chartId] = new Chart(document.getElementById(chartId), {
            type: 'line',
            data: {
                labels,
                datasets: [
                    { label: 'Impressions', data: weeklyData.map(d => d.impressions), borderColor: '#0891b2' },
                    { label: 'Ad Clicks', data: weeklyData.map(d => d.clicks), borderColor: '#f97316' },
                    { label: 'Glance Views', data: weeklyData.map(d => d.glanceViews), borderColor: '#4f46e5' }
                ]
            },
            options: { responsive: true, maintainAspectRatio: false, scales: { x: { type: 'time', time: { unit: 'week' } }, y: { title: {display: true, text: 'Volume'}}} ,
            plugins: { tooltip: { callbacks: { label: (c) => `${c.raw.toLocaleString()}` } } } }
        });
    }

    function renderSkuOosChart(weeklyData) {
        const chartId = 'skuOosChart';
        if (charts[chartId]) charts[chartId].destroy();
        if (!weeklyData || weeklyData.length === 0) return;
        
        const labels = weeklyData.map(d => d.week);
        charts[chartId] = new Chart(document.getElementById(chartId), {
            type: 'line',
            data: {
                labels,
                datasets: [
                    { label: 'Rep OOS %', data: weeklyData.map(d => d.oos), borderColor: '#dc2626', backgroundColor: 'rgba(220, 38, 38, 0.1)', fill: 'start' },
                    { label: 'Procurable OOS %', data: weeklyData.map(d => d.procOos), borderColor: '#db2777', backgroundColor: 'rgba(219, 39, 119, 0.1)', fill: 'start' }
                ]
            },
            options: { responsive: true, maintainAspectRatio: false, scales: { x: { type: 'time', time: { unit: 'week' } }, y: { title: {display: true, text: 'OOS %'}, ticks: {callback: v => `${(v * 100).toFixed(1)}%`}}},
            plugins: { tooltip: { callbacks: { label: (c) => `${c.dataset.label}: ${(c.raw*100).toFixed(2)}%` } } } }
        });
    }

    function handleSkuAnalysis() {
        const selectedValue = dom.skuSelector.value;
        if (!selectedValue) return;

        if (selectedValue === 'OVERALL') {
            dom.aiModalTitle.textContent = `AI Analysis for Overall Performance`;
            dom.aiResponse.innerHTML = `<p>Generating analysis for the entire catalog...</p><p>This is a placeholder for the AI-generated analysis.</p>`;
        } else {
            dom.aiModalTitle.textContent = `AI Analysis for ${getDisplayTitle(selectedValue)}`;
            dom.aiResponse.innerHTML = `<p>Generating analysis for ${selectedValue}...</p><p>This is a placeholder for the AI-generated analysis.</p>`;
        }
        
        dom.aiLoading.classList.add('hidden');
        dom.aiResponse.classList.remove('hidden');
        dom.aiModal.classList.remove('hidden');
    }

    function handleStrategicAnalysis() {
        dom.wbrContent.innerHTML = `<div class="prose max-w-none"><h2>Strategic Analysis Placeholder</h2><p>This is where the AI-generated weekly business review would appear.</p></div>`;
    }

    function populateMoversMetricSelector() {
        const metrics = {
            revenue: "Revenue",
            units: "Units Sold",
            impressions: "Impressions",
            clicks: "Ad Clicks",
            ctr: "CTR",
            adConversionRate: "Ad CVR",
            adSpend: "Ad Spend",
            adSales: "Ad Sales",
            tacos: "TACOS",
            acos: "ACOS",
            roas: "ROAS",
            glanceViews: "Glance Views",
            conversionRate: "Total CVR",
            asp: "Avg. Selling Price",
            cpc: "Cost per Click",
            oos: "Rep OOS %",
        };
        const metricOptions = Object.entries(metrics).map(([key, label]) => `<option value="${key}">${label}</option>`).join('');
        dom.moversMetricSelector.innerHTML = metricOptions;
        dom.moversMetricSelector.value = 'revenue';
    }

    function populateMatrixSelectors() {
        const metrics = {
            revenue: "Revenue", units: "Units Sold", 
            impressions: "Impressions", clicks: "Ad Clicks", ctr: "CTR", adConversionRate: "Ad CVR",
            adSpend: "Ad Spend", adSales: "Ad Sales",
            tacos: "TACOS", acos: "ACOS", roas: "ROAS", glanceViews: "Glance Views", conversionRate: "Total CVR",
            asp: "Avg. Selling Price", cpc: "Cost per Click", oos: "Rep OOS %",
            procOos: "Procurable Product OOS",
            sellableUnits: "Sellable On Hand Units",
            organicRank: "Organic Ranking", sponsoredRank: "Sponsored Ranking"
        };
        const metricOptions = Object.entries(metrics).map(([key, label]) => `<option value="${key}">${label}</option>`).join('');
        dom.matrixMetricSelector.innerHTML = metricOptions;

        const asins = [...new Set(fullDataset.map(d => d.asin))].sort((a,b) => (productMap[a] || a).localeCompare(productMap[b] || b));
        const asinOptions = asins.map(asin => `<option value="${asin}" title="${getDisplayTitle(asin)}">${getDisplayTitle(asin)}</option>`).join('');
        dom.matrixAsinSelector.innerHTML = asinOptions;
    }

    function renderMatrixTable() {
        clearMatrixFilters(false); 

        const selectedMetrics = Array.from(dom.matrixMetricSelector.selectedOptions).map(opt => ({ key: opt.value, label: opt.text }));
        const selectedAsins = Array.from(dom.matrixAsinSelector.selectedOptions).map(opt => opt.value);
        const selectedPeriods = Array.from(dom.matrixTimePeriodSelector.selectedOptions).map(opt => opt.value);

        matrixPrimarySortMetric = selectedMetrics.length > 0 ? selectedMetrics[0].key : null;

        if (selectedMetrics.length === 0 || selectedAsins.length === 0 || selectedPeriods.length === 0) {
            dom.matrixTableContainer.innerHTML = '<p class="text-slate-500 text-center py-16">Please select at least one metric, one product, and one time period.</p>';
            return;
        }

        const latestDate = new Date(Math.max(...fullDataset.map(d => d.date).filter(d => d instanceof Date)));
        if (isNaN(latestDate.getTime())) return;

        const rows = [];
        selectedAsins.forEach(asin => {
            const asinData = fullDataset.filter(d => d.asin === asin);
            
            selectedMetrics.forEach(metric => {
                const cumulativeMetrics = ['revenue', 'units', 'adSpend', 'adSales', 'glanceViews', 'impressions', 'clicks'];
                const isCumulative = cumulativeMetrics.includes(metric.key);

                const avg4wkData = getPeriodData(asinData, getPeriod(latestDate, 28).start, latestDate);
                const avg16wkData = getPeriodData(asinData, getPeriod(latestDate, 112).start, latestDate);
                const avg32wkData = getPeriodData(asinData, getPeriod(latestDate, 224).start, latestDate);

                let finalAvg4wk, finalAvg16wk, finalAvg32wk;

                if (isCumulative) {
                    finalAvg4wk = (avg4wkData[metric.key] || 0) / 4;
                    finalAvg16wk = (avg16wkData[metric.key] || 0) / 16;
                    finalAvg32wk = (avg32wkData[metric.key] || 0) / 32;
                } else {
                    finalAvg4wk = avg4wkData[metric.key];
                    finalAvg16wk = avg16wkData[metric.key];
                    finalAvg32wk = avg32wkData[metric.key];
                }

                const rowData = {
                    asin: asin,
                    metricKey: metric.key,
                    metricLabel: metric.label,
                    avg4wk: finalAvg4wk,
                    avg16wk: finalAvg16wk,
                    avg32wk: finalAvg32wk,
                    periods: []
                };

                selectedPeriods.forEach(periodValue => {
                    const currentPeriod = getPeriod(latestDate, periodValue);
                    const duration = (currentPeriod.end - currentPeriod.start) / (1000 * 3600 * 24) + 1;
                    const priorPeriodStart = new Date(currentPeriod.start); priorPeriodStart.setUTCDate(priorPeriodStart.getUTCDate() - duration);
                    const priorPeriodEnd = new Date(currentPeriod.start); priorPeriodEnd.setUTCDate(priorPeriodEnd.getUTCDate() - 1);

                    let currentValue, priorValue;
                    if (metric.key === 'organicRank' || metric.key === 'sponsoredRank') {
                        currentValue = null;
                        priorValue = null;
                    } else {
                        currentValue = getPeriodData(asinData, currentPeriod.start, currentPeriod.end)[metric.key];
                        priorValue = getPeriodData(asinData, priorPeriodStart, priorPeriodEnd)[metric.key];
                    }
                    
                    const isNumeric = (val) => val !== null && isFinite(val);
                    rowData.periods.push({
                        currentValue: currentValue,
                        priorValue: priorValue,
                        change: isNumeric(currentValue) && isNumeric(priorValue) ? calculateChange(currentValue, priorValue) : NaN,
                        difference: isNumeric(currentValue) && isNumeric(priorValue) ? currentValue - priorValue : NaN,
                    });
                });
                rows.push(rowData);
            });
        });

        lastMatrixData = { rows };
        drawMatrixTableFromData();
        populateMatrixFilterSelectors();
    }

    function drawMatrixTableFromData(asinsToShow) {
        const { rows } = lastMatrixData;
        const asinsToRender = asinsToShow ? asinsToShow : [...new Set((rows || []).map(r => r.asin))];

        if (!rows || rows.length === 0) {
            dom.matrixTableContainer.innerHTML = '<p class="text-slate-500 text-center py-16">No data to display. Check your selections.</p>';
            return;
        }

        if (asinsToShow && asinsToRender.length === 0) {
            dom.matrixTableContainer.innerHTML = '<p class="text-slate-500 text-center py-16">No products match the current filter criteria.</p>';
            return;
        }

        const selectedPeriods = Array.from(dom.matrixTimePeriodSelector.selectedOptions).map(opt => opt.value);
        
        let tableHtml = '<table class="w-full text-sm text-left text-slate-500">';
        
        let headerHtml = '<thead class="text-xs text-slate-700 uppercase bg-slate-50"><tr>';
        headerHtml += `<th scope="col" class="px-6 py-3" rowspan="2">Metric</th>`;
        headerHtml += `<th scope="col" class="sortable-header px-4 py-3 text-right border-l" rowspan="2" data-sort-key="avg4wk">4-Wk Avg <span class="sort-arrow">${matrixSortState.key === 'avg4wk' ? (matrixSortState.direction === 'desc' ? '▼' : '▲') : '↕'}</span></th>`;
        headerHtml += `<th scope="col" class="sortable-header px-4 py-3 text-right border-l" rowspan="2" data-sort-key="avg16wk">16-Wk Avg <span class="sort-arrow">${matrixSortState.key === 'avg16wk' ? (matrixSortState.direction === 'desc' ? '▼' : '▲') : '↕'}</span></th>`;
        headerHtml += `<th scope="col" class="sortable-header px-4 py-3 text-right border-l" rowspan="2" data-sort-key="avg32wk">32-Wk Avg <span class="sort-arrow">${matrixSortState.key === 'avg32wk' ? (matrixSortState.direction === 'desc' ? '▼' : '▲') : '↕'}</span></th>`;
        
        selectedPeriods.forEach(period => {
            const periodLabel = dom.matrixTimePeriodSelector.querySelector(`option[value="${period}"]`).text;
            headerHtml += `<th scope="col" colspan="4" class="px-6 py-3 text-center border-l">${periodLabel}</th>`;
        });
        headerHtml += '</tr><tr>';
        selectedPeriods.forEach((period, index) => {
             headerHtml += `<th scope="col" class="sortable-header px-4 py-3 text-right border-l" data-sort-key="currentValue" data-period-index="${index}">Value <span class="sort-arrow">${matrixSortState.key === 'currentValue' && matrixSortState.periodIndex === index ? (matrixSortState.direction === 'desc' ? '▼' : '▲') : '↕'}</span></th>`;
            headerHtml += `<th scope="col" class="sortable-header px-4 py-3 text-right" data-sort-key="priorValue" data-period-index="${index}">Prior <span class="sort-arrow">${matrixSortState.key === 'priorValue' && matrixSortState.periodIndex === index ? (matrixSortState.direction === 'desc' ? '▼' : '▲') : '↕'}</span></th>`;
            headerHtml += `<th scope="col" class="sortable-header px-4 py-3 text-right" data-sort-key="difference" data-period-index="${index}">Difference <span class="sort-arrow">${matrixSortState.key === 'difference' && matrixSortState.periodIndex === index ? (matrixSortState.direction === 'desc' ? '▼' : '▲') : '↕'}</span></th>`;
            headerHtml += `<th scope="col" class="sortable-header px-4 py-3 text-right" data-sort-key="change" data-period-index="${index}">% Change <span class="sort-arrow">${matrixSortState.key === 'change' && matrixSortState.periodIndex === index ? (matrixSortState.direction === 'desc' ? '▼' : '▲') : '↕'}</span></th>`;
        });
        headerHtml += '</tr></thead><tbody>';
        tableHtml += headerHtml;
        
        // --- OVERALL SUMMARY SECTION ---
        const selectedMetrics = Array.from(dom.matrixMetricSelector.selectedOptions).map(opt => ({ key: opt.value, label: opt.text }));
        const asinsToRenderSet = new Set(asinsToRender);
        
        tableHtml += `<tr class="asin-header-row"><td colspan="${4 + selectedPeriods.length * 4}" class="px-6 py-2 font-semibold text-slate-800">Overall Summary</td></tr>`;
        
        selectedMetrics.forEach(metric => {
            const cumulativeMetrics = ['revenue', 'units', 'adSpend', 'adSales', 'glanceViews', 'impressions', 'clicks', 'sellableUnits'];
            if (!cumulativeMetrics.includes(metric.key)) {
                return; // Skip non-cumulative metrics for the overall summary
            }

            let summaryData = {
                avg4wk: 0, avg16wk: 0, avg32wk: 0,
                periods: selectedPeriods.map(() => ({ currentValue: 0, priorValue: 0, difference: 0 }))
            };

            const relevantRows = rows.filter(r => asinsToRenderSet.has(r.asin) && r.metricKey === metric.key);
            
            relevantRows.forEach(row => {
                summaryData.avg4wk += row.avg4wk || 0;
                summaryData.avg16wk += row.avg16wk || 0;
                summaryData.avg32wk += row.avg32wk || 0;
                row.periods.forEach((p, i) => {
                    summaryData.periods[i].currentValue += p.currentValue || 0;
                    summaryData.periods[i].priorValue += p.priorValue || 0;
                });
            });

            const isCurrency = ['revenue', 'adSpend', 'adSales'].includes(metric.key);
            const formatValue = (val, withSign = false) => {
                if (!isFinite(val)) return '-';
                let sign = (val > 0 && withSign) ? '+' : '';
                if (isCurrency) return `${sign}${currencySymbol}${val.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
                return `${sign}${val.toLocaleString(undefined, {maximumFractionDigits: 0})}`;
            };
            
            tableHtml += `<tr class="bg-slate-50 border-b font-semibold hover:bg-slate-100">`;
            tableHtml += `<td class="px-6 py-3 text-slate-800">${metric.label}</td>`;
            tableHtml += `<td class="px-4 py-3 value-col border-l">${formatValue(summaryData.avg4wk)}</td>`;
            tableHtml += `<td class="px-4 py-3 value-col border-l">${formatValue(summaryData.avg16wk)}</td>`;
            tableHtml += `<td class="px-4 py-3 value-col border-l">${formatValue(summaryData.avg32wk)}</td>`;
            
            summaryData.periods.forEach(period => {
                period.difference = period.currentValue - period.priorValue;
                const change = calculateChange(period.currentValue, period.priorValue);
                const isGood = period.difference === 0 ? null : period.difference > 0;
                const colorClass = isGood === null ? '' : (isGood ? 'text-emerald-600' : 'text-red-600');
                let formattedChange = '<span class="text-slate-400">-</span>';
                if (isFinite(change)) {
                    const changeColorClass = isGood === null ? 'bg-slate-100 text-slate-800' : (isGood ? 'bg-emerald-100 text-emerald-800' : 'bg-red-100 text-red-800');
                    const sign = change > 0 ? '▲' : '▼';
                    formattedChange = `<span class="${changeColorClass}">${sign} ${(Math.abs(change) * 100).toFixed(1)}%</span>`;
                }

                tableHtml += `<td class="px-4 py-3 value-col border-l">${formatValue(period.currentValue)}</td>`;
                tableHtml += `<td class="px-4 py-3 value-col text-slate-500">${formatValue(period.priorValue)}</td>`;
                tableHtml += `<td class="px-4 py-3 value-col font-medium ${colorClass}">${formatValue(period.difference, true)}</td>`;
                tableHtml += `<td class="px-4 py-3 change-col">${formattedChange}</td>`;
            });
            tableHtml += `</tr>`;
        });
        
        // --- INDIVIDUAL PRODUCT SECTION ---
        asinsToRender.forEach(asin => {
            tableHtml += `<tr class="asin-header-row"><td colspan="${4 + selectedPeriods.length * 4}" class="px-6 py-2 font-semibold text-slate-800">${getDisplayTitle(asin)}</td></tr>`;
            rows.filter(row => row.asin === asin).forEach(rowData => {
                const isPrimarySortMetric = matrixPrimarySortMetric === rowData.metricKey;
                const primaryClass = isPrimarySortMetric ? 'primary-sort-metric' : '';

                tableHtml += `<tr class="bg-white border-b hover:bg-slate-50">`;
                tableHtml += `<td class="px-6 py-4 metric-name-col sort-metric-selector hover:bg-slate-100 ${primaryClass}" data-metric-key="${rowData.metricKey}">${rowData.metricLabel}</td>`;
                
                const isCurrency = ['revenue', 'adSpend', 'adSales', 'asp', 'cpc'].includes(rowData.metricKey);
                const isPercent = ['tacos', 'acos', 'conversionRate', 'oos', 'ctr', 'procOos', 'adConversionRate'].includes(rowData.metricKey);
                const isRank = ['organicRank', 'sponsoredRank'].includes(rowData.metricKey);
                const isRatio = ['roas'].includes(rowData.metricKey);

                const formatValue = (val, withSign = false) => {
                    if (val === null || typeof val !== 'number' || !isFinite(val)) return '-';
                    let sign = (val > 0 && withSign) ? '+' : '';
                    if (isCurrency) return `${sign}${currencySymbol}${val.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
                    if (isPercent) return `${sign}${(val * 100).toFixed(2)}%`;
                    if (isRatio) return `${sign}${val.toFixed(2)}`;
                    if (isRank) return `${sign}${val.toFixed(1)}`;
                    return `${sign}${val.toLocaleString(undefined, {maximumFractionDigits: 0})}`;
                };

                tableHtml += `<td class="px-4 py-4 value-col border-l">${formatValue(rowData.avg4wk)}</td>`;
                tableHtml += `<td class="px-4 py-4 value-col border-l">${formatValue(rowData.avg16wk)}</td>`;
                tableHtml += `<td class="px-4 py-4 value-col border-l">${formatValue(rowData.avg32wk)}</td>`;

                rowData.periods.forEach(periodData => {
                    const formattedValue = formatValue(periodData.currentValue);
                    const formattedPriorValue = formatValue(periodData.priorValue);
                    const formattedDifference = formatValue(periodData.difference, true);
                    const isGoodWhenDown = ['adSpend', 'tacos', 'acos', 'cpc', 'oos', 'procOos', 'organicRank', 'sponsoredRank'].includes(rowData.metricKey);
                    const isGood = periodData.difference === 0 ? null : (isGoodWhenDown ? (periodData.difference < 0) : (periodData.difference > 0));
                    const colorClass = isGood === null ? '' : (isGood ? 'text-emerald-600' : 'text-red-600');
                    let formattedChange = '<span class="text-slate-400">-</span>';
                    if (isFinite(periodData.change)) {
                        const changeColorClass = isGood === null ? 'bg-slate-100 text-slate-800' : (isGood ? 'bg-emerald-100 text-emerald-800' : 'bg-red-100 text-red-800');
                        const sign = periodData.change > 0 ? '▲' : '▼';
                        formattedChange = `<span class="${changeColorClass}">${sign} ${(Math.abs(periodData.change) * 100).toFixed(1)}%</span>`;
                    }
                    tableHtml += `<td class="px-4 py-4 value-col border-l">${formattedValue}</td>`;
                    tableHtml += `<td class="px-4 py-4 value-col text-slate-500">${formattedPriorValue}</td>`;
                    tableHtml += `<td class="px-4 py-4 value-col font-medium ${colorClass}">${formattedDifference}</td>`;
                    tableHtml += `<td class="px-4 py-4 change-col">${formattedChange}</td>`;
                });
                tableHtml += `</tr>`;
            });
        });
        tableHtml += '</tbody></table>';

        dom.matrixTableContainer.innerHTML = tableHtml;
    }


    function populateMatrixFilterSelectors() {
        const selectedMetrics = Array.from(dom.matrixMetricSelector.selectedOptions).map(opt => ({ key: opt.value, label: opt.text }));
        const selectedPeriods = Array.from(dom.matrixTimePeriodSelector.selectedOptions).map(opt => ({ key: opt.value, label: opt.text }));
        const avgPeriods = [
            { key: 'avg4wk', label: '4-Wk Avg' },
            { key: 'avg16wk', label: '16-Wk Avg' },
            { key: 'avg32wk', label: '32-Wk Avg' }
        ];

        dom.matrixFilterMetric.innerHTML = selectedMetrics.map(m => `<option value="${m.key}">${m.label}</option>`).join('');
        dom.matrixFilterPeriod.innerHTML = [...avgPeriods, ...selectedPeriods].map(p => `<option value="${p.key}">${p.label}</option>`).join('');

        dom.matrixFilterPeriod.addEventListener('change', () => {
             const isAvg = ['avg4wk', 'avg16wk', 'avg32wk'].includes(dom.matrixFilterPeriod.value);
             dom.matrixFilterColumn.querySelector('option[value="change"]').disabled = isAvg;
             if(isAvg) dom.matrixFilterColumn.value = 'currentValue';
        });

    }

    function applyMatrixFilters() {
        if (!lastMatrixData.rows || lastMatrixData.rows.length === 0) return;

        const metricKey = dom.matrixFilterMetric.value;
        const periodKey = dom.matrixFilterPeriod.value;
        const column = dom.matrixFilterColumn.value;
        const operator = dom.matrixFilterOperator.value;
        let value1 = parseFloat(dom.matrixFilterValue1.value);
        let value2 = parseFloat(dom.matrixFilterValue2.value);

        if (column === 'change') {
            if (!isNaN(value1)) value1 /= 100;
            if (!isNaN(value2)) value2 /= 100;
        }

        if (isNaN(value1) || (operator === 'between' && isNaN(value2))) {
             clearMatrixFilters(true);
             return;
        }

        const selectedPeriods = Array.from(dom.matrixTimePeriodSelector.selectedOptions).map(opt => opt.value);
        const periodIndex = selectedPeriods.indexOf(periodKey);
        
        const allAsins = [...new Set(lastMatrixData.rows.map(d => d.asin))];

        const filteredAsins = allAsins.filter(asin => {
            const row = lastMatrixData.rows.find(r => r.asin === asin && r.metricKey === metricKey);
            if (!row) return false;

            let valueToCheck;
            if (periodIndex !== -1) {
                 valueToCheck = row.periods[periodIndex][column];
            } else {
                 valueToCheck = row[periodKey]; // For avg columns
            }

            if (typeof valueToCheck !== 'number' || !isFinite(valueToCheck)) return false;

            switch(operator) {
                case 'gt': return valueToCheck > value1;
                case 'lt': return valueToCheck < value1;
                case 'between': return valueToCheck >= value1 && valueToCheck <= value2;
                default: return true;
            }
        });
        
        activeMatrixFilterAsins = filteredAsins;
        drawMatrixTableFromData(activeMatrixFilterAsins);
    }

    function clearMatrixFilters(redraw = true) {
        dom.matrixFilterValue1.value = '';
        dom.matrixFilterValue2.value = '';
        dom.matrixFilterOperator.value = 'gt';
        dom.matrixFilterValue2.classList.add('hidden');
        
        activeMatrixFilterAsins = null;
        
        if (redraw) {
            drawMatrixTableFromData(); 
        }
    }


    function renderMoversAndDecliners(sortedData) {
        const periodValue = dom.moversTimeSelector.value;
        const metricKey = dom.moversMetricSelector.value;
        const metricDef = {
             isCurrency: ['revenue', 'adSpend', 'adSales', 'asp', 'cpc'].includes(metricKey),
             isPercent: ['tacos', 'acos', 'conversionRate', 'oos', 'ctr', 'procOos', 'adConversionRate'].includes(metricKey),
             isRatio: ['roas'].includes(metricKey),
             isGoodWhenDown: ['adSpend', 'tacos', 'acos', 'cpc', 'oos', 'procOos'].includes(metricKey)
        };

        const latestDate = new Date(Math.max(...fullDataset.map(d => d.date).filter(d => d instanceof Date)));
        if (isNaN(latestDate.getTime())) return;

        const currentPeriod = getPeriod(latestDate, periodValue);
        const duration = Math.round((currentPeriod.end - currentPeriod.start) / (1000 * 3600 * 24)) + 1;
        const priorPeriodStart = new Date(currentPeriod.start); priorPeriodStart.setUTCDate(priorPeriodStart.getUTCDate() - duration);
        const priorPeriodEnd = new Date(currentPeriod.start); priorPeriodEnd.setUTCDate(priorPeriodEnd.getUTCDate() - 1);
        
        document.getElementById('moversTimeRangeText').textContent = `Comparing ${formatDate(currentPeriod.start)} - ${formatDate(currentPeriod.end)} vs ${formatDate(priorPeriodStart)} - ${formatDate(priorPeriodEnd)}`;

        let changeData;

        if (sortedData) {
            changeData = sortedData;
        } else {
            const asinsToProcess = moversFilteredAsins !== null ? moversFilteredAsins : [...new Set(fullDataset.map(d => d.asin))];
            
            changeData = asinsToProcess.map(asin => {
                const asinData = fullDataset.filter(d => d.asin === asin);
                const currentData = getPeriodData(asinData, currentPeriod.start, currentPeriod.end);
                const priorData = getPeriodData(asinData, priorPeriodStart, priorPeriodEnd);
                
                const currentValue = currentData[metricKey];
                const priorValue = priorData[metricKey];
                
                if (typeof currentValue !== 'number' || typeof priorValue !== 'number' || !isFinite(currentValue) || !isFinite(priorValue)) {
                    return null;
                }

                const absoluteChange = currentValue - priorValue;
                const percentChange = calculateChange(currentValue, priorValue);
                
                return { asin, title: productMap[asin] || asin, absoluteChange, percentChange, currentValue, priorValue };
            }).filter(d => d && d.absoluteChange !== 0);
        }

        let topMovers = changeData.filter(d => d.absoluteChange > 0);
        let topDecliners = changeData.filter(d => d.absoluteChange < 0);
        
        topMovers.sort((a, b) => {
            const valA = a[moversSortState.column];
            const valB = b[moversSortState.column];
            const comparison = typeof valA === 'string' ? valA.localeCompare(valB) : valA - valB;
            return moversSortState.direction === 'desc' ? -comparison : comparison;
        });

        topDecliners.sort((a, b) => {
            const valA = a[declinersSortState.column];
            const valB = b[declinersSortState.column];
            const comparison = typeof valA === 'string' ? valA.localeCompare(valB) : valA - valB;
            return declinersSortState.direction === 'desc' ? -comparison : comparison;
        });

        const moversToShow = topMovers.slice(0, 20);
        const declinersToShow = topDecliners.slice(0, 20);

        const calculateSummary = (data) => {
            if (data.length === 0) return null;
            const summary = data.reduce((acc, d) => {
                acc.currentValue += d.currentValue;
                acc.priorValue += d.priorValue;
                return acc;
            }, { currentValue: 0, priorValue: 0 });
            summary.absoluteChange = summary.currentValue - summary.priorValue;
            summary.percentChange = calculateChange(summary.currentValue, summary.priorValue);
            return summary;
        };

        const moversSummary = calculateSummary(moversToShow);
        const declinersSummary = calculateSummary(declinersToShow);

        document.getElementById('topMoversTable').innerHTML = createMoversTable(moversToShow, true, metricDef, moversSortState, moversSummary);
        document.getElementById('topDeclinersTable').innerHTML = createMoversTable(declinersToShow, false, metricDef, declinersSortState, declinersSummary);
    }

    function createMoversTable(data, isUplift, metricDef, sortState, summary) {
        if (data.length === 0) return `<p class="text-center text-slate-500 py-8">No ${isUplift ? 'uplifts' : 'downlifts'} in this period.</p>`;
        
        const formatValue = (val, isChange = false) => {
            if (!isFinite(val) || val === null) return '-';
            const sign = (isChange && val > 0) ? '+' : '';
            if (metricDef.isCurrency) return `${sign}${currencySymbol}${val.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            if (metricDef.isPercent) {
                return isChange ? `${sign}${(val * 100).toFixed(2)}p.p.` : `${(val * 100).toFixed(2)}%`;
            }
            if (metricDef.isRatio) {
                 return `${sign}${val.toFixed(2)}`;
            }
            return `${sign}${val.toLocaleString(undefined, {maximumFractionDigits: 0})}`;
        };

        const arrow = (key) => sortState.column === key ? (sortState.direction === 'desc' ? '▼' : '▲') : '↕';

        const headers = `
            <thead class="text-xs text-slate-700 uppercase bg-slate-50">
                <tr>
                    <th class="sortable-header px-4 py-2" data-sort-key="title">Product <span class="sort-arrow">${arrow('title')}</span></th>
                    <th class="sortable-header px-4 py-2 text-right" data-sort-key="currentValue">Current <span class="sort-arrow">${arrow('currentValue')}</span></th>
                    <th class="sortable-header px-4 py-2 text-right" data-sort-key="priorValue">Prior <span class="sort-arrow">${arrow('priorValue')}</span></th>
                    <th class="sortable-header px-4 py-2 text-right" data-sort-key="percentChange">% Change <span class="sort-arrow">${arrow('percentChange')}</span></th>
                    <th class="sortable-header px-4 py-2 text-right" data-sort-key="absoluteChange">Change <span class="sort-arrow">${arrow('absoluteChange')}</span></th>
                </tr>
            </thead>`;
        
        const rows = data.map(d => {
            const isGood = metricDef.isGoodWhenDown ? !isUplift : isUplift;
            const colorClass = isGood ? 'text-emerald-600' : 'text-red-600';
            
            return `
            <tr class="border-b">
                <td class="px-4 py-2 font-medium text-slate-800 product-title-cell">${getDisplayTitle(d.asin)}</td>
                <td class="px-4 py-2 text-right text-slate-600">${formatValue(d.currentValue)}</td>
                <td class="px-4 py-2 text-right text-slate-500">${formatValue(d.priorValue)}</td>
                <td class="px-4 py-2 text-right font-semibold ${colorClass}">${isFinite(d.percentChange) ? `${(d.percentChange * 100).toFixed(1)}%` : '-'}</td>
                <td class="px-4 py-2 text-right font-semibold ${colorClass}">${formatValue(d.absoluteChange, true)}</td>
            </tr>
        `}).join('');

        let footer = '';
        if (summary) {
            const isGood = metricDef.isGoodWhenDown ? (summary.absoluteChange < 0) : (summary.absoluteChange > 0);
            const colorClass = isGood ? 'text-emerald-600' : 'text-red-600';
            footer = `
            <tfoot class="font-bold">
                <tr class="border-t-2 border-slate-300">
                    <td class="px-4 py-2">Overall</td>
                    <td class="px-4 py-2 text-right">${formatValue(summary.currentValue)}</td>
                    <td class="px-4 py-2 text-right">${formatValue(summary.priorValue)}</td>
                    <td class="px-4 py-2 text-right ${colorClass}">${isFinite(summary.percentChange) ? `${(summary.percentChange * 100).toFixed(1)}%` : '-'}</td>
                    <td class="px-4 py-2 text-right ${colorClass}">${formatValue(summary.absoluteChange, true)}</td>
                </tr>
            </tfoot>`;
        }
        
        return `<table class="w-full text-sm text-left">${headers}<tbody>${rows}</tbody>${footer}</table>`;
    }

    function handleMoversSort(event, type) {
        const header = event.target.closest('.sortable-header');
        if (!header) return;

        const sortKey = header.dataset.sortKey;
        const sortState = type === 'movers' ? moversSortState : declinersSortState;

        if (sortState.column === sortKey) {
            sortState.direction = sortState.direction === 'asc' ? 'desc' : 'asc';
        } else {
            sortState.column = sortKey;
            sortState.direction = (type === 'movers' && sortKey !== 'title') ? 'desc' : 'asc';
        }
        
        renderMoversAndDecliners(); 
    }

    function populateMoversFilterSelectors() {
        const metrics = {
            revenue: "Revenue", units: "Units Sold", 
            impressions: "Impressions", clicks: "Ad Clicks", ctr: "CTR", adConversionRate: "Ad CVR",
            adSpend: "Ad Spend", adSales: "Ad Sales",
            tacos: "TACOS", acos: "ACOS", roas: "ROAS", glanceViews: "Glance Views", conversionRate: "Total CVR",
            asp: "Avg. Selling Price", cpc: "Cost per Click", oos: "Rep OOS %",
            procOos: "Procurable Product OOS", sellableUnits: "Sellable On Hand Units",
            organicRank: "Organic Ranking", sponsoredRank: "Sponsored Ranking"
        };
        const metricOptions = Object.entries(metrics).map(([key, label]) => `<option value="${key}">${label}</option>`).join('');
        dom.moversFilterMetric.innerHTML = metricOptions;

        const avgPeriods = [
            { key: 'avg4wk', label: '4-Wk Avg' },
            { key: 'avg16wk', label: '16-Wk Avg' },
            { key: 'avg32wk', label: '32-Wk Avg' }
        ];
        const standardPeriods = [
            { key: '7', label: 'Last 7 Days' }, { key: '14', label: 'Last 2 Weeks' },
            { key: '28', label: 'Last 4 Weeks' }, { key: '91', label: 'Last Quarter (13 wks)' },
            { key: '182', label: 'Last 6 Months (26 wks)' }, { key: '365', label: 'Last 1 Year (52 wks)' }
        ];

        const combinedPeriods = [...avgPeriods, ...standardPeriods];
        const periodOptions = combinedPeriods.map(p => `<option value="${p.key}">${p.label}</option>`).join('');
        dom.moversFilterPeriod.innerHTML = periodOptions;
        dom.moversFilterPeriod.value = '28';

        dom.moversFilterPeriod.addEventListener('change', () => {
            const isAvg = ['avg4wk', 'avg16wk', 'avg32wk'].includes(dom.moversFilterPeriod.value);
            dom.moversFilterColumn.querySelector('option[value="change"]').disabled = isAvg;
            if (isAvg) {
                dom.moversFilterColumn.value = 'currentValue';
            }
        });
    }

    function applyMoversFilter() {
        const metricKey = dom.moversFilterMetric.value;
        const periodKey = dom.moversFilterPeriod.value;
        const column = dom.moversFilterColumn.value;
        const operator = dom.moversFilterOperator.value;
        let value1 = parseFloat(dom.moversFilterValue1.value);
        let value2 = parseFloat(dom.moversFilterValue2.value);

        if (column === 'change') {
            if (!isNaN(value1)) value1 /= 100;
            if (!isNaN(value2)) value2 /= 100;
        }

        if (isNaN(value1) || (operator === 'between' && isNaN(value2))) {
            clearMoversFilter(true);
            return;
        }

        const latestDate = new Date(Math.max(...fullDataset.map(d => d.date).filter(d => d instanceof Date)));
        if (isNaN(latestDate.getTime())) return;

        const allAsins = [...new Set(fullDataset.map(d => d.asin))];
        const isAvgPeriod = periodKey.startsWith('avg');

        const filteredAsins = allAsins.filter(asin => {
            const asinData = fullDataset.filter(d => d.asin === asin);
            if (asinData.length === 0) return false;

            let valueToCheck;

            if (isAvgPeriod) {
                const numWeeks = parseInt(periodKey.replace('avg', '').replace('wk', ''), 10);
                const avgPeriodStart = getPeriod(latestDate, numWeeks * 7).start;
                const avgPeriodEnd = latestDate;

                if (metricKey === 'organicRank' || metricKey === 'sponsoredRank') {
                    valueToCheck = null; 
                } else {
                    const cumulativeMetrics = ['revenue', 'units', 'adSpend', 'adSales', 'glanceViews', 'impressions', 'clicks'];
                    const isCumulative = cumulativeMetrics.includes(metricKey);
                    const avgData = getPeriodData(asinData, avgPeriodStart, avgPeriodEnd);
                    
                    if (isCumulative) {
                        valueToCheck = (avgData[metricKey] || 0) / numWeeks;
                    } else {
                        valueToCheck = avgData[metricKey];
                    }
                }
            } else {
                const currentPeriod = getPeriod(latestDate, periodKey);
                const duration = Math.round((currentPeriod.end - currentPeriod.start) / (1000 * 3600 * 24)) + 1;
                const priorPeriodStart = new Date(currentPeriod.start); priorPeriodStart.setUTCDate(priorPeriodStart.getUTCDate() - duration);
                const priorPeriodEnd = new Date(currentPeriod.start); priorPeriodEnd.setUTCDate(priorPeriodEnd.getUTCDate() - 1);

                let currentValue, priorValue;
                if (metricKey === 'organicRank' || metricKey === 'sponsoredRank') {
                    currentValue = null; 
                    priorValue = null;
                } else {
                    currentValue = getPeriodData(asinData, currentPeriod.start, currentPeriod.end)[metricKey];
                    priorValue = getPeriodData(asinData, priorPeriodStart, priorPeriodEnd)[metricKey];
                }

                if (column === 'currentValue') {
                    valueToCheck = currentValue;
                } else { 
                    valueToCheck = calculateChange(currentValue, priorValue);
                }
            }
            
            if (typeof valueToCheck !== 'number' || !isFinite(valueToCheck)) return false;

            switch(operator) {
                case 'gt': return valueToCheck > value1;
                case 'lt': return valueToCheck < value1;
                case 'between': return valueToCheck >= value1 && valueToCheck <= value2;
                default: return true;
            }
        });
        
        moversFilteredAsins = filteredAsins;
        renderMoversAndDecliners();
    }

    function clearMoversFilter(redraw = true) {
        dom.moversFilterValue1.value = '';
        dom.moversFilterValue2.value = '';
        dom.moversFilterOperator.value = 'gt';
        dom.moversFilterValue2.classList.add('hidden');
        
        moversFilteredAsins = null;
        
        if (redraw) {
            renderMoversAndDecliners(); 
        }
    }

    function generateFlywheelNarrative(weeklyData) {
        if (!weeklyData || weeklyData.length < 4) { 
            return '<p>Not enough data to generate a conclusion. Please select a longer time period.</p>';
        }

        const midPoint = Math.floor(weeklyData.length / 2);
        const firstHalf = weeklyData.slice(0, midPoint);
        const secondHalf = weeklyData.slice(midPoint);

        const getAverage = (data, key) => {
            if (data.length === 0) return 0;
            const sum = data.reduce((acc, d) => acc + d[key], 0);
            return sum / data.length;
        };

        const avgOosFirst = getAverage(firstHalf, 'oos');
        const avgOosSecond = getAverage(secondHalf, 'oos');
        const oosTrend = avgOosSecond - avgOosFirst;

        const avgGvFirst = getAverage(firstHalf, 'glanceViews');
        const avgGvSecond = getAverage(secondHalf, 'glanceViews');
        const gvTrend = avgGvSecond - avgGvFirst;

        const avgCrFirst = getAverage(firstHalf, 'conversionRate');
        const avgCrSecond = getAverage(secondHalf, 'conversionRate');
        const crTrend = avgCrSecond - avgCrFirst;

        let conclusions = [];
        let score = 0;

        if (avgOosSecond > 0.05) { 
            conclusions.push('<li><strong>Availability Concern:</strong> The Out of Stock rate is consistently high. This is a major blocker to growth.</li>');
            score--;
        } else if (oosTrend > 0.001) { 
            conclusions.push('<li><strong>Availability Risk:</strong> The Out of Stock rate is increasing, which can halt the flywheel.</li>');
            score--;
        } else {
            conclusions.push('<li><strong>Availability is Healthy:</strong> The Out of Stock rate is low and stable.</li>');
            score++;
        }

        if (gvTrend > 0) {
            conclusions.push('<li><strong>Traffic is Growing:</strong> Glance Views are trending upwards.</li>');
            score++;
        } else {
            conclusions.push('<li><strong>Traffic is Stalling:</strong> Glance Views are declining or flat.</li>');
            score--;
        }

        if (crTrend > 0) {
            conclusions.push('<li><strong>Conversion is Improving:</strong> The Conversion Rate is trending upwards.</li>');
            score++;
        } else {
            conclusions.push('<li><strong>Conversion is Declining:</strong> The Conversion Rate is falling.</li>');
            score--;
        }

        let summary = '';
        if (score >= 2) {
            summary = '<p class="font-semibold text-emerald-700">✅ Flywheel is Accelerating: Positive trends are driving growth.</p>';
        } else if (score <= -1) {
            summary = '<p class="font-semibold text-red-700">❌ Flywheel is Stalling or Reversing: Multiple key metrics are trending negatively.</p>';
        } else {
            summary = '<p class="font-semibold text-amber-700">⚠️ Flywheel Health is Mixed: There are both positive and negative signals.</p>';
        }

        return `${summary}<ul class="list-disc list-inside mt-2 space-y-1">${conclusions.join('')}</ul>`;
    }

    function renderFlywheelDiagnosis() {
        const asin = dom.flywheelAsinSelector.value;
        const weeks = parseInt(dom.flywheelTimeSelector.value, 10);
        if (!asin) return;

        const latestDate = new Date(Math.max(...fullDataset.map(d => d.date).filter(d => d instanceof Date)));
        if (isNaN(latestDate.getTime())) return;
        
        const end = new Date(latestDate);
        const start = new Date(latestDate);
        start.setUTCDate(start.getUTCDate() - (weeks * 7 - 1));

        const asinData = fullDataset.filter(d => d.asin === asin && d.date >= start && d.date <= end);
        const weeklyData = aggregateWeekly(asinData);

        renderFlywheelChart('flywheelOosChart', 'OOS %', weeklyData, 'oos', '#dc2626', true);
        renderFlywheelChart('flywheelGvChart', 'Glance Views', weeklyData, 'glanceViews', '#4f46e5', false);
        renderFlywheelChart('flywheelCrChart', 'Conversion Rate %', weeklyData, 'conversionRate', '#16a34a', true);

        document.getElementById('flywheelNarrative').innerHTML = generateFlywheelNarrative(weeklyData);
    }

    function renderFlywheelChart(canvasId, label, data, key, color, isPercent) {
        if (charts[canvasId]) charts[canvasId].destroy();
        const labels = data.map(d => d.week);
        const chartData = data.map(d => isPercent ? d[key] * 100 : d[key]);
        
        charts[canvasId] = new Chart(document.getElementById(canvasId), {
            type: 'line',
            data: {
                labels,
                datasets: [{
                    label,
                    data: chartData,
                    borderColor: color,
                    backgroundColor: `${color}1A`,
                    fill: 'start',
                    tension: 0.3,
                    pointRadius: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false }, title: { display: true, text: label } },
                scales: {
                    x: { type: 'time', time: { unit: 'week' }, ticks: { display: false } },
                    y: { beginAtZero: true, ticks: { callback: v => isPercent ? `${v.toFixed(1)}%` : v.toLocaleString() } }
                }
            }
        });
    }

    function renderRankingAnalysisSection() {
        if (!dom.rankingStartDateInput.value || !dom.rankingEndDateInput.value) {
            const allDates = [...heliumData.map(d => d.date)].filter(Boolean);
            if (allDates.length > 0) {
                const allTimestamps = allDates.map(d => d.getTime());
                const maxDate = new Date(Math.max(...allTimestamps));
                const minDate = new Date(Math.min(...allTimestamps));
                
                dom.rankingEndDateInput.value = maxDate.toISOString().split('T')[0];
                dom.rankingStartDateInput.value = minDate.toISOString().split('T')[0];
            }
        }
        
        if (!dom.rankingStartDateInput.value || !dom.rankingEndDateInput.value) {
            console.warn("Could not set a valid date range for ranking analysis.");
            return;
        }
        
        renderCompetitorRankingChart();
    }

    function populateKeywordFilter() {
        const selectedMainAsin = dom.mainAsinFilterSelector.value;
        const keywordSelector = dom.keywordFilterSelector;

        keywordSelector.innerHTML = '<option value="">-- Select Keyword --</option>';
        keywordSelector.disabled = true;

        if (selectedMainAsin && mainAsinKeywordsMap.has(selectedMainAsin)) {
            const keywords = Array.from(mainAsinKeywordsMap.get(selectedMainAsin)).sort();
            keywordSelector.innerHTML += keywords.map(kw => `<option value="${kw}">${kw}</option>`).join('');
            keywordSelector.disabled = false;
        }
    }


    function renderCompetitorRankingChart() {
        const chartId = 'competitorRankingChart';
        if (charts[chartId]) charts[chartId].destroy();

        const canvas = document.getElementById(chartId);
        const canvasParent = canvas.parentElement;
        
        const mainAsin = dom.mainAsinFilterSelector.value;
        const selectedKeyword = dom.keywordFilterSelector.value;
        const selectedRankKey = dom.rankTypeSelector.value;
        const rankTypeText = dom.rankTypeSelector.options[dom.rankTypeSelector.selectedIndex].text;
        const startDate = new Date(dom.rankingStartDateInput.value + 'T00:00:00Z');
        const endDate = new Date(dom.rankingEndDateInput.value + 'T00:00:00Z');

        const showMessage = (msg) => {
            canvas.style.display = 'none';
            let p = canvasParent.querySelector('p.message-text');
            if (!p) {
                p = document.createElement('p');
                p.className = 'text-center text-slate-500 py-16 message-text';
                canvasParent.insertBefore(p, canvas);
            }
            p.textContent = msg;
            p.style.display = 'block';
             document.getElementById('competitorRankingChartTitle').textContent = `Competitive Rank Landscape`;
        };
        
        if (!mainAsin) {
            showMessage('Please select a competitor group to view data.');
            return;
        }
        
        if (!selectedKeyword) {
            showMessage('Please select a keyword to view the ranking landscape.');
            return;
        }
        
        const competitorAsins = Array.from(mainAsinCompetitorsMap.get(mainAsin) || []);
        const periodData = heliumData.filter(d => 
            d.date >= startDate && 
            d.date <= endDate && 
            competitorAsins.includes(d.asin) &&
            d.keyword === selectedKeyword
        );

        if (periodData.length === 0) {
            showMessage(`No ${rankTypeText.toLowerCase()} ranking data for this group and keyword in the selected period.`);
            return;
        }
        
        canvas.style.display = 'block';
        let p = canvasParent.querySelector('p.message-text');
        if (p) p.style.display = 'none';
        document.getElementById('competitorRankingChartTitle').textContent = `Competitive ${rankTypeText} Rank Landscape for "${selectedKeyword}"`;


        const datasets = [];
        const colors = ['#e11d48', '#16a34a', '#3b82f6', '#f97316', '#8b5cf6', '#64748b', '#0891b2', '#ca8a04', '#1d4ed8', '#be185d'];

        competitorAsins.forEach((compAsin, i) => {
            const rankDataForComp = periodData.filter(d => d.asin === compAsin);
            if (rankDataForComp.length === 0) return;

            const color = colors[i % colors.length];

            datasets.push({
                label: getDisplayTitle(compAsin),
                data: rankDataForComp.map(d => ({ x: d.date.getTime(), y: d[selectedRankKey] })).filter(d => d.y !== null),
                borderColor: color,
                backgroundColor: color,
                borderWidth: 2,
                pointRadius: 1,
                tension: 0.2
            });
        });

        charts[chartId] = new Chart(canvas, {
            type: 'line',
            data: { datasets },
            options: {
                responsive: true, maintainAspectRatio: false,
                scales: {
                    x: { type: 'time', time: { unit: 'day', tooltipFormat: 'dd MMM yy' } },
                    y: { reverse: true, title: { display: true, text: 'Rank (Lower is better)' } }
                },
                plugins: {
                    legend: { labels: { boxWidth: 20, padding: 15 } },
                    tooltip: {
                        callbacks: {
                            label: (context) => {
                                let label = context.dataset.label || '';
                                if (label) { label += ': '; }
                                if (context.parsed.y !== null) { label += `Rank ${context.parsed.y.toFixed(0)}`; }
                                return label;
                            }
                        }
                    }
                }
            }
        });
    }

    function getWeekNumber(d) {
        d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
        d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay()||7));
        var yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
        var weekNo = Math.ceil(( ( (d - yearStart) / 86400000) + 1)/7);
        return weekNo;
    }

    // --- START: Wholesale Specific Functions ---

    function setupWholesaleContactFilter() {
        const uniqueContacts = [...new Set(wholesaleDataset.map(d => d.contactName))].sort();

        dom.wholesaleContactSearchInput.addEventListener('input', e => {
            const searchTerm = e.target.value.toLowerCase();
            if (!searchTerm) {
                dom.wholesaleContactSearchDropdown.classList.add('hidden');
                return;
            }
            const filtered = uniqueContacts.filter(c => 
                !selectedWholesaleContacts.includes(c) && c.toLowerCase().includes(searchTerm)
            );
            
            if (filtered.length > 0) {
                dom.wholesaleContactSearchDropdown.innerHTML = filtered.slice(0, 50).map(c => 
                    `<div class="p-2 hover:bg-slate-100 cursor-pointer" data-contact="${c}">${c}</div>`
                ).join('');
                dom.wholesaleContactSearchDropdown.classList.remove('hidden');
            } else {
                dom.wholesaleContactSearchDropdown.classList.add('hidden');
            }
        });

        dom.wholesaleContactSearchDropdown.addEventListener('click', e => {
            if (e.target && e.target.matches('div[data-contact]')) {
                const contact = e.target.dataset.contact;
                addWholesaleContactPill(contact);
                dom.wholesaleContactSearchInput.value = '';
                dom.wholesaleContactSearchDropdown.classList.add('hidden');
            }
        });
        
        dom.wholesaleShowAllContactsBtn.addEventListener('click', () => {
             selectedWholesaleContacts = [];
             dom.wholesaleContactSearchPills.innerHTML = '';
             renderWholesaleDashboard();
        });

        document.addEventListener('click', (e) => {
            const container = document.getElementById('wholesaleContactSearchContainer');
            if (container && !container.contains(e.target)) {
                dom.wholesaleContactSearchDropdown.classList.add('hidden');
            }
        });
    }

    function addWholesaleContactPill(contact) {
        if (!selectedWholesaleContacts.includes(contact)) {
            selectedWholesaleContacts.push(contact);
            const pill = document.createElement('div');
            pill.className = 'search-pill';
            pill.dataset.contact = contact;
            pill.innerHTML = `<span>${contact.substring(0,25)}</span><button>×</button>`;
            pill.querySelector('button').addEventListener('click', (e) => {
                e.stopPropagation();
                removeWholesaleContactPill(contact);
            });
            dom.wholesaleContactSearchPills.appendChild(pill);
            renderWholesaleDashboard();
        }
    }

    function removeWholesaleContactPill(contact) {
        selectedWholesaleContacts = selectedWholesaleContacts.filter(c => c !== contact);
        const pillToRemove = dom.wholesaleContactSearchPills.querySelector(`div[data-contact="${contact}"]`);
        if (pillToRemove) {
            dom.wholesaleContactSearchPills.removeChild(pillToRemove);
        }
        renderWholesaleDashboard();
    }

    function populateWeekSelector(filteredData) {
        const container = dom.wholesaleWeekSelectorContainer;
        container.innerHTML = ''; 

        if (!filteredData || filteredData.length === 0) {
            container.innerHTML = '<p class="text-slate-500">No data for the selected period.</p>';
            return;
        }

        const uniqueWeeks = [...new Set(filteredData.map(d => getWeekKey(d.date)))].sort();
        
        uniqueWeeks.forEach(weekKey => {
            const weekNum = getWeekNumber(new Date(weekKey));
            const btn = document.createElement('button');
            btn.className = "px-3 py-1 text-sm font-semibold bg-slate-200 text-slate-700 rounded-md hover:bg-indigo-500 hover:text-white transition-colors";
            btn.textContent = `WK ${weekNum}`;
            btn.onclick = () => showWholesaleDetail(weekKey, null);
            container.appendChild(btn);
        });
    }

    function renderWholesaleDashboard() {
        if (wholesaleDataset.length === 0) {
             document.getElementById('wholesaleTab').innerHTML = '<div class="card p-6 text-center text-slate-500">No Wholesale Sales data found or data could not be processed.</div>';
             return;
        }
        
        const startDate = new Date(dom.wholesaleStartDate.value + 'T00:00:00Z');
        const endDate = new Date(dom.wholesaleEndDate.value + 'T23:59:59Z');

        let filteredData = wholesaleDataset.filter(d => d.date >= startDate && d.date <= endDate);

        if (selectedWholesaleContacts.length > 0) {
            const contactSet = new Set(selectedWholesaleContacts);
            filteredData = filteredData.filter(d => contactSet.has(d.contactName));
        }

        renderWholesaleKPIs(filteredData);
        renderWholesaleBestSellersTable(filteredData);
        renderWholesaleParetoChart(filteredData);
        renderWholesaleMoversAndDecliners(filteredData, startDate, endDate);
        populateWeekSelector(filteredData);
        renderWholesaleChart(filteredData);
    }

    function renderWholesaleKPIs(data) {
        const kpiUniqueProducts = document.getElementById('kpi-uniqueProducts');
        const kpiTopProduct = document.getElementById('kpi-topProduct');
        const kpiRevenueConcentration = document.getElementById('kpi-revenueConcentration');
        const kpiAvgRevenuePerProduct = document.getElementById('kpi-avgRevenuePerProduct');

        if (!data || data.length === 0) {
            kpiUniqueProducts.innerHTML = `<h4 class="text-slate-500 font-semibold">Unique Products Sold</h4><p class="text-3xl font-bold text-slate-800">0</p>`;
            kpiTopProduct.innerHTML = `<h4 class="text-slate-500 font-semibold">Top Product (Revenue)</h4><p class="text-3xl font-bold text-slate-800">N/A</p>`;
            kpiRevenueConcentration.innerHTML = `<h4 class="text-slate-500 font-semibold">Top 10 Revenue Share</h4><p class="text-3xl font-bold text-slate-800">0%</p>`;
            kpiAvgRevenuePerProduct.innerHTML = `<h4 class="text-slate-500 font-semibold">Avg Revenue / Product</h4><p class="text-3xl font-bold text-slate-800">${currencySymbol}0</p>`;
            return;
        }

        const productSales = data.reduce((acc, d) => {
            acc[d.description] = (acc[d.description] || 0) + d.salesValue;
            return acc;
        }, {});

        const sortedProducts = Object.entries(productSales).sort((a,b) => b[1] - a[1]);
        const uniqueProductsCount = sortedProducts.length;
        const totalRevenue = data.reduce((sum, d) => sum + d.salesValue, 0);

        const topProduct = sortedProducts[0] ? sortedProducts[0][0] : 'N/A';
        const topProductRevenue = sortedProducts[0] ? sortedProducts[0][1] : 0;
        
        const top10Revenue = sortedProducts.slice(0, 10).reduce((sum, [, revenue]) => sum + revenue, 0);
        const revenueConcentration = totalRevenue > 0 ? (top10Revenue / totalRevenue) * 100 : 0;
        
        const avgRevenuePerProduct = uniqueProductsCount > 0 ? totalRevenue / uniqueProductsCount : 0;
        
        kpiUniqueProducts.innerHTML = `<h4 class="text-slate-500 font-semibold">Unique Products Sold</h4><p class="text-3xl font-bold text-slate-800">${uniqueProductsCount.toLocaleString()}</p>`;
        kpiTopProduct.innerHTML = `<h4 class="text-slate-500 font-semibold">Top Product (Revenue)</h4><p class="text-xl font-bold text-slate-800 truncate" title="${topProduct}">${topProduct}</p><p class="text-sm text-slate-600">${currencySymbol}${topProductRevenue.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</p>`;
        kpiRevenueConcentration.innerHTML = `<h4 class="text-slate-500 font-semibold">Top 10 Revenue Share</h4><p class="text-3xl font-bold text-slate-800">${revenueConcentration.toFixed(1)}%</p>`;
        kpiAvgRevenuePerProduct.innerHTML = `<h4 class="text-slate-500 font-semibold">Avg Revenue / Product</h4><p class="text-3xl font-bold text-slate-800">${currencySymbol}${avgRevenuePerProduct.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</p>`;
    }
    
    function renderWholesaleBestSellersTable(data) {
        if (!data || data.length === 0) {
            dom.wholesaleBestSellersContainer.innerHTML = `<p class="text-center text-slate-500 py-8">No product data for this period.</p>`;
            return;
        }

        const totalRevenue = data.reduce((sum, d) => sum + d.salesValue, 0);

        const productData = data.reduce((acc, d) => {
            if (!acc[d.description]) {
                acc[d.description] = {
                    revenue: 0,
                    quantity: 0,
                    contacts: new Set()
                };
            }
            acc[d.description].revenue += d.salesValue;
            acc[d.description].quantity += d.quantity;
            acc[d.description].contacts.add(d.contactName);
            return acc;
        }, {});

        const tableData = Object.entries(productData).map(([description, metrics]) => ({
            description,
            revenue: metrics.revenue,
            quantity: metrics.quantity,
            revenueShare: totalRevenue > 0 ? (metrics.revenue / totalRevenue) : 0,
            uniqueContacts: metrics.contacts.size,
            avgPrice: metrics.quantity > 0 ? metrics.revenue / metrics.quantity : 0
        }));
        
        drawWholesaleBestSellersTable(tableData);

        dom.wholesaleBestSellersContainer.addEventListener('click', e => {
            const header = e.target.closest('.sortable-header');
            if (header) {
                const sortKey = header.dataset.sortKey;
                if (wholesaleBestSellersSortState.column === sortKey) {
                    wholesaleBestSellersSortState.direction = wholesaleBestSellersSortState.direction === 'desc' ? 'asc' : 'desc';
                } else {
                    wholesaleBestSellersSortState.column = sortKey;
                    wholesaleBestSellersSortState.direction = 'desc';
                }
                drawWholesaleBestSellersTable(tableData);
            }
        });
    }

    function drawWholesaleBestSellersTable(data) {
        const sortKey = wholesaleBestSellersSortState.column;
        const sortDir = wholesaleBestSellersSortState.direction;

        data.sort((a,b) => {
            const valA = a[sortKey];
            const valB = b[sortKey];
            if (typeof valA === 'string') {
                 return sortDir === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
            }
            return sortDir === 'asc' ? valA - valB : valB - valA;
        });

        const arrow = (key) => sortKey === key ? (sortDir === 'desc' ? '▼' : '▲') : '↕';

        let tableHtml = `<table class="w-full text-sm text-left">
            <thead class="text-xs text-slate-700 uppercase bg-slate-50"><tr>
                <th class="sortable-header px-4 py-2" data-sort-key="description">Product <span class="sort-arrow">${arrow('description')}</span></th>
                <th class="sortable-header px-4 py-2 text-right" data-sort-key="revenue">Revenue <span class="sort-arrow">${arrow('revenue')}</span></th>
                <th class="sortable-header px-4 py-2 text-right" data-sort-key="quantity">Qty Sold <span class="sort-arrow">${arrow('quantity')}</span></th>
                <th class="sortable-header px-4 py-2 text-right" data-sort-key="revenueShare">% of Total <span class="sort-arrow">${arrow('revenueShare')}</span></th>
                <th class="sortable-header px-4 py-2 text-right" data-sort-key="uniqueContacts">Unique Contacts <span class="sort-arrow">${arrow('uniqueContacts')}</span></th>
                <th class="sortable-header px-4 py-2 text-right" data-sort-key="avgPrice">Avg. Price <span class="sort-arrow">${arrow('avgPrice')}</span></th>
            </tr></thead><tbody>`;
        
        data.forEach(d => {
            tableHtml += `<tr class="border-b">
                <td class="px-4 py-2 font-medium text-slate-800">${d.description}</td>
                <td class="px-4 py-2 text-right">${currencySymbol}${d.revenue.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                <td class="px-4 py-2 text-right">${d.quantity.toLocaleString()}</td>
                <td class="px-4 py-2 text-right">${(d.revenueShare * 100).toFixed(1)}%</td>
                <td class="px-4 py-2 text-right">${d.uniqueContacts}</td>
                <td class="px-4 py-2 text-right">${currencySymbol}${d.avgPrice.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
            </tr>`;
        });

        tableHtml += '</tbody></table>';
        dom.wholesaleBestSellersContainer.innerHTML = tableHtml;
    }

    function renderWholesaleParetoChart(data) {
        const chartId = 'wholesaleParetoChart';
        if (charts[chartId]) charts[chartId].destroy();

        if (!data || data.length === 0) { return; }

        const productSales = data.reduce((acc, d) => {
            acc[d.description] = (acc[d.description] || 0) + d.salesValue;
            return acc;
        }, {});
        
        let sortedProducts = Object.entries(productSales).sort((a,b) => b[1] - a[1]);
        const totalRevenue = sortedProducts.reduce((sum, [, revenue]) => sum + revenue, 0);
        
        let displayProducts = sortedProducts;
        if (sortedProducts.length > 40) { // Group if too many products
            const top39 = sortedProducts.slice(0, 39);
            const othersRevenue = sortedProducts.slice(39).reduce((sum, [,r]) => sum + r, 0);
            displayProducts = [...top39, ['Others', othersRevenue]];
        }

        const labels = displayProducts.map(([desc]) => desc);
        const revenues = displayProducts.map(([, revenue]) => revenue);
        
        let cumulativePercentage = 0;
        const cumulativeData = sortedProducts.map(([, revenue]) => {
            cumulativePercentage += (revenue / totalRevenue) * 100;
            return cumulativePercentage;
        });

        charts[chartId] = new Chart(document.getElementById(chartId), {
            type: 'bar',
            data: {
                labels: labels.map(l => l.substring(0,20) + (l.length > 20 ? '...': '')),
                datasets: [
                    { label: 'Revenue', data: revenues, backgroundColor: '#4f46e5', yAxisID: 'y' },
                    { label: 'Cumulative %', data: cumulativeData, borderColor: '#f97316', type: 'line', yAxisID: 'y1', pointRadius: 0 }
                ]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                scales: {
                    x: { ticks: { autoSkip: true, maxRotation: 90, minRotation: 45 } },
                    y: { position: 'left', title: {display: true, text: `Revenue (${currencySymbol})`} },
                    y1: { position: 'right', grid: {drawOnChartArea: false}, max: 100, title: {display: true, text: 'Cumulative Revenue %'}, ticks: {callback: v => `${v.toFixed(0)}%`}}
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            title: (context) => {
                                const dataIndex = context[0].dataIndex;
                                return labels[dataIndex];
                            }
                        }
                    }
                }
            }
        });
    }

    function renderWholesaleMoversAndDecliners(currentPeriodData, startDate, endDate) {
        const duration = Math.round((endDate - startDate) / (1000 * 3600 * 24)) + 1;
        const priorPeriodStart = new Date(startDate); priorPeriodStart.setUTCDate(priorPeriodStart.getUTCDate() - duration);
        const priorPeriodEnd = new Date(startDate); priorPeriodEnd.setUTCDate(priorPeriodEnd.getUTCDate() - 1);

        dom.wholesaleMoversTimeRangeText.textContent = `Comparing vs ${formatDate(priorPeriodStart)} - ${formatDate(priorPeriodEnd)}`;

        let priorPeriodData = wholesaleDataset.filter(d => d.date >= priorPeriodStart && d.date <= priorPeriodEnd);
        
        if (selectedWholesaleContacts.length > 0) {
            const contactSet = new Set(selectedWholesaleContacts);
            priorPeriodData = priorPeriodData.filter(d => contactSet.has(d.contactName));
        }

        const currentSales = currentPeriodData.reduce((acc, d) => {
            acc[d.description] = (acc[d.description] || 0) + d.salesValue;
            return acc;
        }, {});
        
        const priorSales = priorPeriodData.reduce((acc, d) => {
            acc[d.description] = (acc[d.description] || 0) + d.salesValue;
            return acc;
        }, {});

        const allProducts = [...new Set([...Object.keys(currentSales), ...Object.keys(priorSales)])];

        const changeData = allProducts.map(desc => {
            const currentValue = currentSales[desc] || 0;
            const priorValue = priorSales[desc] || 0;
            const absoluteChange = currentValue - priorValue;
            const percentChange = calculateChange(currentValue, priorValue);
            return { description: desc, currentValue, priorValue, absoluteChange, percentChange };
        }).filter(d => d.absoluteChange !== 0);

        dom.wholesaleTopMoversContainer.innerHTML = createWholesaleMoversTable(changeData.filter(d => d.absoluteChange > 0), true, wholesaleMoversSortState);
        dom.wholesaleTopDeclinersContainer.innerHTML = createWholesaleMoversTable(changeData.filter(d => d.absoluteChange < 0), false, wholesaleDeclinersSortState);

        dom.wholesaleTopMoversContainer.addEventListener('click', (e) => handleWholesaleMoversSort(e, true, changeData));
        dom.wholesaleTopDeclinersContainer.addEventListener('click', (e) => handleWholesaleMoversSort(e, false, changeData));
    }

    function createWholesaleMoversTable(data, isUplift, sortState) {
        const sortKey = sortState.column;
        const sortDir = sortState.direction;

        data.sort((a,b) => {
             const valA = a[sortKey];
             const valB = b[sortKey];
             if (typeof valA === 'string') {
                  return sortDir === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
             }
             return sortDir === 'asc' ? valA - valB : valB - valA;
        });
        
        const dataToShow = data.slice(0, 20);

        if (dataToShow.length === 0) return `<p class="text-center text-slate-500 py-4">No significant ${isUplift ? 'uplifts' : 'downlifts'}.</p>`;

        const arrow = (key) => sortKey === key ? (sortDir === 'desc' ? '▼' : '▲') : '↕';

        let table = `<table class="w-full text-sm">
            <thead class="text-xs text-slate-700 uppercase bg-slate-50"><tr>
                <th class="sortable-header px-4 py-2" data-sort-key="description">Product <span class="sort-arrow">${arrow('description')}</span></th>
                <th class="sortable-header px-4 py-2 text-right" data-sort-key="currentValue">Current <span class="sort-arrow">${arrow('currentValue')}</span></th>
                <th class="sortable-header px-4 py-2 text-right" data-sort-key="priorValue">Prior <span class="sort-arrow">${arrow('priorValue')}</span></th>
                <th class="sortable-header px-4 py-2 text-right" data-sort-key="percentChange">% Change <span class="sort-arrow">${arrow('percentChange')}</span></th>
                <th class="sortable-header px-4 py-2 text-right" data-sort-key="absoluteChange">Change <span class="sort-arrow">${arrow('absoluteChange')}</span></th>
            </tr></thead><tbody>`;

        const color = isUplift ? 'text-emerald-600' : 'text-red-600';
        
        dataToShow.forEach(d => {
            const percentChangeText = isFinite(d.percentChange) ? `${(d.percentChange * 100).toFixed(1)}%` : '-';
            const sign = d.absoluteChange > 0 ? '+' : '';

            table += `<tr class="border-b">
                <td class="px-4 py-1">${d.description}</td>
                <td class="px-4 py-1 text-right">${currencySymbol}${d.currentValue.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                <td class="px-4 py-1 text-right text-slate-500">${currencySymbol}${d.priorValue.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                <td class="px-4 py-1 text-right font-semibold ${color}">${percentChangeText}</td>
                <td class="px-4 py-1 text-right font-semibold ${color}">${sign}${currencySymbol}${d.absoluteChange.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
            </tr>`;
        });
        table += '</tbody></table>';
        return table;
    }

    function handleWholesaleMoversSort(event, isUplift, data) {
        const header = event.target.closest('.sortable-header');
        if (!header) return;

        const sortKey = header.dataset.sortKey;
        const sortState = isUplift ? wholesaleMoversSortState : wholesaleDeclinersSortState;

        if (sortState.column === sortKey) {
            sortState.direction = sortState.direction === 'asc' ? 'desc' : 'asc';
        } else {
            sortState.column = sortKey;
            sortState.direction = 'desc'; // Default to descending for new column
        }

        const container = isUplift ? dom.wholesaleTopMoversContainer : dom.wholesaleTopDeclinersContainer;
        const filteredData = isUplift ? data.filter(d => d.absoluteChange > 0) : data.filter(d => d.absoluteChange < 0);
        
        container.innerHTML = createWholesaleMoversTable(filteredData, isUplift, sortState);
    }


    function renderWholesaleChart(filteredData) {
        const chartId = 'wholesaleChart';
        const canvas = document.getElementById(chartId);
        if (charts[chartId]) charts[chartId].destroy();
        
        if (filteredData.length === 0) {
            return;
        }
        
        const contactTotals = filteredData.reduce((acc, row) => {
            acc[row.contactName] = (acc[row.contactName] || 0) + row.salesValue;
            return acc;
        }, {});

        const sortedContacts = Object.entries(contactTotals).sort((a,b) => b[1] - a[1]);
        const topContacts = new Set(sortedContacts.slice(0, 11).map(d => d[0]));
        
        const groupedData = filteredData.map(row => ({
            ...row,
            contactName: topContacts.has(row.contactName) ? row.contactName : 'Others'
        }));

        const weeklyData = groupedData.reduce((acc, row) => {
            const weekKey = getWeekKey(row.date);
            if (!acc[weekKey]) acc[weekKey] = {};
            acc[weekKey][row.contactName] = (acc[weekKey][row.contactName] || 0) + row.salesValue;
            return acc;
        }, {});

        const weeks = Object.keys(weeklyData).sort();
        const finalContacts = [...new Set(groupedData.map(d => d.contactName))].sort((a,b) => {
            if (a === 'Others') return 1; if (b === 'Others') return -1;
            return a.localeCompare(b);
        });
        
        const colors = ['#4338ca', '#6d28d9', '#16a34a', '#dc2626', '#db2777', '#f97316', '#0891b2', '#ca8a04', '#1d4ed8', '#be185d', '#0e7490', '#6b7280'];

        const datasets = finalContacts.map((contact, i) => ({
            label: contact,
            data: weeks.map(week => weeklyData[week][contact] || 0),
            backgroundColor: colors[i % colors.length]
        }));
        
        const weeklyTotals = weeks.map(week => Object.values(weeklyData[week]).reduce((sum, val) => sum + val, 0));

        const timeSpanDays = weeks.length > 1 ? (new Date(weeks[weeks.length - 1]) - new Date(weeks[0])) / (1000 * 3600 * 24) : 0;
        const timeUnit = timeSpanDays > 540 ? 'month' : 'week';

        charts[chartId] = new Chart(canvas, {
            type: 'bar',
            data: { labels: weeks, datasets },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: (context) => {
                                const contact = context.dataset.label;
                                const value = context.raw;
                                const weekIndex = context.dataIndex;
                                const weekTotal = weeklyTotals[weekIndex];
                                const percentage = weekTotal > 0 ? (value / weekTotal * 100).toFixed(1) : 0;
                                return `${contact}: ${currencySymbol}${value.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})} (${percentage}%)`;
                            }
                        }
                    }
                },
                scales: {
                    x: { 
                        stacked: true, 
                        type: 'time', 
                        time: { unit: timeUnit, tooltipFormat: 'MMM d, yyyy' },
                        ticks: { display: false }
                    },
                    y: { stacked: true, title: { display: true, text: `Weekly Sales (${currencySymbol})` } }
                },
                onClick: (event, elements) => {
                    if (elements.length > 0) {
                        const weekIndex = elements[0].index;
                        const contactIndex = elements[0].datasetIndex;
                        const week = weeks[weekIndex];
                        const contact = finalContacts[contactIndex];
                        showWholesaleDetail(week, contact);
                    }
                }
            }
        });
    }

    function showWholesaleDetail(week, contactName) {
        const weekStart = new Date(week);
        const isOverallView = contactName === null;

        let title = '';
        let filteredData = wholesaleDataset.filter(d => getWeekKey(d.date) === week);
        
        if (selectedWholesaleContacts.length > 0) {
            const contactSet = new Set(selectedWholesaleContacts);
            filteredData = filteredData.filter(d => contactSet.has(d.contactName));
        }

        if (contactName && contactName !== 'Others') {
            title = `Sales for ${contactName} - Week of ${formatDate(weekStart)}`;
            filteredData = filteredData.filter(d => d.contactName === contactName);
        } else if (contactName === 'Others') {
            title = `Sales for "Others" - Week of ${formatDate(weekStart)}`;
            const contactTotals = filteredData.reduce((acc, row) => {
                acc[row.contactName] = (acc[row.contactName] || 0) + row.salesValue;
                return acc;
            }, {});
            const sortedContacts = Object.entries(contactTotals).sort((a,b) => b[1] - a[1]);
            const topContacts = new Set(sortedContacts.slice(0, 11).map(d => d[0]));
            filteredData = filteredData.filter(d => !topContacts.has(d.contactName));
        } else {
            title = `Overall Sales - Week of ${formatDate(weekStart)}`;
        }
        
        const totalSales = filteredData.reduce((sum, d) => sum + d.salesValue, 0);

        const productSales = filteredData.reduce((acc, d) => {
            const key = d.description;
            acc[key] = (acc[key] || 0) + d.salesValue;
            return acc;
        }, {});

        const sortedProducts = Object.entries(productSales).sort((a,b) => b[1] - a[1]);

        let tableHtml = `<div class="prose max-w-none"><table>
            <thead>
                <tr>
                    <th>Product Description</th>
                    <th>Revenue (${currencySymbol})</th>
                    <th>% of Total</th>
                </tr>
            </thead>
            <tbody>`;

        sortedProducts.forEach(([description, sales]) => {
            const percentage = totalSales > 0 ? (sales / totalSales * 100).toFixed(1) : 0;
            const clickHandler = isOverallView ? `onclick="showWholesaleProductDetail('${week}', '${description.replace(/'/g, "\\'")}')" style="cursor: pointer;"` : '';
            const hoverClass = isOverallView ? 'hover:bg-slate-100' : '';
            const drilldownHint = isOverallView ? '<span class="text-xs text-blue-500 ml-2">(click to see breakdown)</span>' : '';
            
            tableHtml += `
                <tr class="${hoverClass}" ${clickHandler}>
                    <td>${description} ${drilldownHint}</td>
                    <td class="text-right">${sales.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                    <td class="text-right">${percentage}%</td>
                </tr>`;
        });
        
        tableHtml += '</tbody></table></div>';

        dom.aiModalTitle.textContent = title;
        dom.aiResponse.innerHTML = tableHtml;
        dom.aiModalContent.scrollTop = 0; 
        dom.aiLoading.classList.add('hidden');
        dom.aiResponse.classList.remove('hidden');
        dom.aiModal.classList.remove('hidden');
    }
    
    function showWholesaleProductDetail(week, productDescription) {
        const weekStart = new Date(week);
        const title = `Breakdown for "${productDescription}" - Week of ${formatDate(weekStart)}`;

        let weeklyProductData = wholesaleDataset.filter(d => {
            const dWeek = getWeekKey(d.date);
            return dWeek === week && d.description === productDescription;
        });

        if (selectedWholesaleContacts.length > 0) {
            const contactSet = new Set(selectedWholesaleContacts);
            weeklyProductData = weeklyProductData.filter(d => contactSet.has(d.contactName));
        }

        const totalSales = weeklyProductData.reduce((sum, d) => sum + d.salesValue, 0);

        const contactSales = weeklyProductData.reduce((acc, d) => {
            acc[d.contactName] = (acc[d.contactName] || 0) + d.salesValue;
            return acc;
        }, {});

        const sortedContacts = Object.entries(contactSales).sort((a,b) => b[1] - a[1]);

        let tableHtml = `<div class="prose max-w-none"><table>
            <thead>
                <tr>
                    <th>Contact Name</th>
                    <th>Revenue (${currencySymbol})</th>
                    <th>% of Total for this Product</th>
                </tr>
            </thead>
            <tbody>`;

        sortedContacts.forEach(([contact, sales]) => {
            const percentage = totalSales > 0 ? (sales / totalSales * 100).toFixed(1) : 0;
            tableHtml += `
                <tr>
                    <td>${contact}</td>
                    <td class="text-right">${sales.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                    <td class="text-right">${percentage}%</td>
                </tr>`;
        });
        
        tableHtml += '</tbody></table></div>';
        
        dom.aiModalTitle.textContent = title;
        dom.aiResponse.innerHTML = tableHtml;
        dom.aiModalContent.scrollTop = 0; 
    }
    // --- END: Wholesale Specific Functions ---
});
</script>
</body>
</html>
